
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>AICON Walkthrough &#8212; AICON Walkthrough</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=b4b5ee4a" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'aicon01_walkthrough';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Contents" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="AICON Walkthrough - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="AICON Walkthrough - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">AICON Walkthrough</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/aicon01_walkthrough.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>AICON Walkthrough</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aicon-model-training">AICON model training</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#driver-code">Driver code</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#training-datasets-and-variables">Training datasets and variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checkpoint-files">Checkpoint files</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hidden-mesh-multi-mesh-definition">Hidden mesh / multi-mesh definition</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-architecture">Model architecture</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#encoder-decoder-model">Encoder-decoder model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#encoder-and-decoder-graph">Encoder and decoder graph</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gnn-processor">GNN Processor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#attention-graph">Attention Graph</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transfer-learning">Transfer learning</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-dwd-inference-tool">Running the DWD inference tool</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bibliography">Bibliography</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="aicon-walkthrough">
<h1>AICON Walkthrough<a class="headerlink" href="#aicon-walkthrough" title="Link to this heading">#</a></h1>
<p><em>Florian Prill, Deutscher Wetterdienst (DWD), December 2025</em></p>
<hr class="docutils" />
<div style="max-width: 100%;color:#696969;"><i>
DWD team for data-driven NWP: Roland Potthast, Jan Keller, Stefanie Hollborn, Nora Schenk, Thomas Deppisch, Nastaran Najari, Florian Prill, Tobias Göcke, Marek Jacob, Hendrik Reich, Sabrina Wahl, Sven Ulbrich
</i></div>
<p/>
<div style="max-width: 100%;color:#696969;"><i>
Disclaimer: All scripts, software packages and formats explained in this Jupyter Notebook are subject to change! 
The <a href="https://github.com/ecmwf/anemoi-graphs/pull/53">(first) AICON functionalities</a> were added to the Anemoi codebase in November 2024. The first version of the DWD software for AICON inference was completed at the end of March 2025.
</i></div>
<p/>
<hr class="docutils" />
<p>This Jupyter notebook has been uploaded to https://gitlab.dkrz.de/fprill/aicon-walkthrough/</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>There has been substantial progress in the field of data-driven weather forecasting. FourCastNet, Pangu-Weather, GraphCast, GenCast and Aurora (developed by NVIDIA, Huawei, Google DeepMind and Microsoft) are just a few examples.
At DWD, ML-based forecasts are seen as a complement to the global and regional ICON model for numerical weather prediction.</p>
<p>The DWD model <strong>AICON</strong> is based on Graph Neural Networks (GNNs). This approach was introduced to global weather prediction by [Keisler2022] and treats the Earth as a graph with nodes representing spatial locations.</p>
<p>In June 2024, DWD adopted the shared Anemoi codebase for its research and development.
The <strong>Anemoi Framework</strong> is a collaborative European initiative driving the development of machine-learning–powered weather models across Europe. It underpins key systems including ECMWF’s Artificial Intelligence Forecasting System (AIFS), MetNorway’s Bris (which extends AIFS), and DWD’s AICON. Recognized with the EMS Technology Achievement Award 2025, Anemoi’s development is closely aligned with EUMETNET’s E‑AI program on Artificial Intelligence and Machine Learning in Weather, Climate and Environmental Application.</p>
<figure style="text-align: right; width: 50%; margin-left: auto;">
  <img src="_static/aicon_global_spec_humidity_l101.png" alt="Specific humidity, ICON level 101" style="width: 100%;">
  <figcaption>Example of an AICON-Global forecast for specific humidity at the respective ICON vertical level 101
Source: <a href="https://www.dwd.de/DE/fachnutzer/forschung_lehre/numerische_wettervorhersage/nwv_aenderungen/_functions/DownloadBox_modellaenderungen/icon/pdf_2025/pdf_icon_03_09_2025.pdf?__blob=publicationFile&v=2">2025-09-03, Operationelles NWV-System Änderungsmitteilung.</a></figcaption>
</figure>
<hr class="docutils" />
<p>In this Jupyter notebook, we take a deep dive into AICON.</p>
<p>The Anemoi codebase for GNNs is built from various Github repositories [Lang2024]:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/ecmwf/anemoi-core"><code class="docutils literal notranslate"><span class="pre">anemoi-core</span></code></a>: core packages that define the GNN graphs, the models and the driver code for training.</p></li>
<li><p><a class="reference external" href="https://github.com/ecmwf/anemoi-datasets"><code class="docutils literal notranslate"><span class="pre">anemoi-datasets</span></code></a>: high-level interface for I/O operations, based on a YAML recipe files.</p></li>
<li><p><a class="reference external" href="https://github.com/ecmwf/anemoi-inference"><code class="docutils literal notranslate"><span class="pre">anemoi-inference</span></code></a>: package for generation of ML-driven weather predictions</p></li>
<li><p>other supporting repositories, eg. <a class="reference external" href="https://github.com/ecmwf/anemoi-transform"><code class="docutils literal notranslate"><span class="pre">anemoi-transform</span></code></a></p></li>
</ul>
<p>The framework builds upon established Python tools including PyTorch, Lightning, Hydra, Zarr, Xarray and earthkit.
See the documentation at https://anemoi.readthedocs.io for further info.
The GNN implementation is based on the <code class="docutils literal notranslate"><span class="pre">torch_geometric</span></code> (<a class="reference external" href="https://pytorch-geometric.readthedocs.io/en/latest/">PyTorch Geometric</a>, PyG) library.</p>
<p><img alt="Package logos" src="_images/logos.png" /></p>
</section>
<section id="aicon-model-training">
<h2>AICON model training<a class="headerlink" href="#aicon-model-training" title="Link to this heading">#</a></h2>
<p>Installing the packages can be complicated. The exact versions of the packages also play an important role.
For this reason, the necessary <a class="reference external" href="https://gitlab.dkrz.de/aicon/anemoi/anemoi-dwd">ingredients for AICON</a> are summarized here in a file <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> and can be installed collectively using <code class="docutils literal notranslate"><span class="pre">pip</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="nb">dir</span> <span class="o">-</span><span class="n">U</span> <span class="o">-</span><span class="n">r</span> <span class="o">../</span><span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>

<span class="c1"># List all the installed packages with their versions:</span>
<span class="c1"># (do not forget to remove the capture command if you want to see the output)</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">freeze</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../requirements.txt&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;git&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-e git+https://github.com/ecmwf/anemoi-core.git@training-0.7.0#egg=anemoi-training[test]&amp;subdirectory=training
 -e git+https://github.com/ecmwf/anemoi-core.git@models-0.10.0#egg=anemoi-models&amp;subdirectory=models
 -e git+https://github.com/ecmwf/anemoi-core.git@graphs-0.7.2#egg=anemoi-graphs&amp;subdirectory=graphs
 -e git+https://github.com/ecmwf/anemoi-datasets.git@0.5.28#egg=anemoi-datasets
</pre></div>
</div>
</div>
</div>
<p>Before we start, let’s make some basic settings for this Jupyter notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="o">%</span><span class="k">load_ext</span> mermaid_magic
<span class="o">%</span><span class="k">load_ext</span> nb_js_diagrammers
</pre></div>
</div>
</div>
</div>
<p>Later on, we will work with GRIB2 datasets. GRIB is a compact binary format for gridded weather data. Field names in GRIB come from parameter codes that are translated using external code tables. Therefore, we need to set definition paths.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="k">if</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gpnl&quot;</span><span class="p">):</span>
    <span class="o">%</span><span class="k">env</span> ECCODES_PYTHON_USE_FINDLIBS=0
    <span class="o">%</span><span class="k">env</span> ECCODES_DEFINITION_PATH=/hpc/sw/eccodes/definitions/release/2.44.0/definitions.edzw:/hpc/sw/eccodes/definitions/release/2.44.0/definitions
<span class="k">else</span><span class="p">:</span>
    <span class="o">%</span><span class="k">env</span> ECCODES_DEFINITION_PATH=/mnt/data/ai/icon_vert_interp/definitions.edzw-2.35.0/release/2.35.0/definitions.edzw:/usr/share/eccodes/definitions
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: ECCODES_PYTHON_USE_FINDLIBS=0
env: ECCODES_DEFINITION_PATH=/hpc/sw/eccodes/definitions/release/2.44.0/definitions.edzw:/hpc/sw/eccodes/definitions/release/2.44.0/definitions
</pre></div>
</div>
</div>
</div>
<section id="driver-code">
<h3>Driver code<a class="headerlink" href="#driver-code" title="Link to this heading">#</a></h3>
<p>In the past months the AICON implementation (for global forecasts) has already entered the <code class="docutils literal notranslate"><span class="pre">main</span></code> versions of the respective Anemoi repositories.
The <a class="reference external" href="https://github.com/ecmwf/anemoi-core/blob/main/training/tests/integration/aicon/test_cicd_aicon_04_icon-dream_medium.yaml">AICON integration test</a> would be a good starting point to learn about the setup.
However, we plan to go into more detail here and we begin with a short explanation of the driver code necessary for <strong>AICON training</strong>.</p>
<p>First, we load a <a class="reference download internal" download="" href="_downloads/bc0a12bea8449dda4681411e5544dae9/test_aicon_01.yaml"><span class="xref download myst">YAML configuration</span></a>. YAML is an easy-to-read data format commonly used for configuration files.
We will discuss some details of the YAML configuration below. For now, we will accept the settings as they are.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config_filename</span> <span class="o">=</span> <span class="s2">&quot;test_aicon_01.yaml&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">hydra</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">anemoi.training</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;ANEMOI_CONFIG_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">anemoi</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">hydra</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">version_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">hydra</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">config_name</span><span class="o">=</span><span class="n">config_filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We use this to construct an Anemoi trainer object. Running the driver code in an interactive Jupyter notebook requires a slight modification (<code class="docutils literal notranslate"><span class="pre">JupyterNotebookStrategy</span></code>), which allows us to select a notebook-compatible strategy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">anemoi.training.train.train</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnemoiTrainer</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">AnemoiTrainer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">JupyterNotebookStrategy</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_rank</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">trainer</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">JupyterNotebookStrategy</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The trainer uses the environment variable <code class="docutils literal notranslate"><span class="pre">ANEMOI_BASE_SEED</span></code> to initialize a pseudorandom number generator so that it produces a repeatable initialization of weights:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ANEMOI_BASE_SEED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;42&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>As a small technical addition, we are implementing a “live logger,” i.e., a class that plots the history of the loss function without additional tools.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytorch_lightning.loggers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>

<span class="k">class</span><span class="w"> </span><span class="nc">GraphicalLiveLogger</span><span class="p">(</span><span class="n">Logger</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="o">=</span> <span class="s2">&quot;train_weighted_mse_loss_step&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@property</span> 
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s2">&quot;LiveLogger&quot;</span>
    <span class="nd">@property</span> 
    <span class="k">def</span><span class="w"> </span><span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s2">&quot;0.1&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_hyperparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">step</span><span class="p">,</span> <span class="n">metrics</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="n">steps</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span><span class="n">m</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="ow">in</span> <span class="n">m</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">));</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;AICON&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> over steps&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Step&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">logger_enabled</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">loggers</span> <span class="o">=</span> <span class="n">GraphicalLiveLogger</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Seed set to 42000
/shared/data/fprill/aicon_walkthrough/venv/src/anemoi-datasets/src/anemoi/datasets/data/forwards.py:517: UserWarning: The behaviour of Join.collect_supporting_arrays() is not well defined
  warnings.warn(f&quot;The behaviour of {self.__class__.__name__}.collect_supporting_arrays() is not well defined&quot;)
/shared/data/fprill/aicon_walkthrough/venv/src/anemoi-datasets/src/anemoi/datasets/data/forwards.py:517: UserWarning: The behaviour of Join.collect_supporting_arrays() is not well defined
  warnings.warn(f&quot;The behaviour of {self.__class__.__name__}.collect_supporting_arrays() is not well defined&quot;)
</pre></div>
</div>
</div>
</div>
<p>Now we can perform a short training run for the neural network:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0,1,2,3,4,5,6,7]
</pre></div>
</div>
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━┳━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┳━━━━━━━┓
┃<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">   </span>┃<span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> Name    </span>┃<span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> Type                 </span>┃<span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> Params </span>┃<span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> Mode  </span>┃<span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> FLOPs </span>┃
┡━━━╇━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━╇━━━━━━━┩
│<span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 0 </span>│ model   │ AnemoiModelInterface │  443 K │ train │     0 │
│<span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 1 </span>│ loss    │ WeightedMSELoss      │      0 │ train │     0 │
│<span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 2 </span>│ metrics │ ModuleDict           │      0 │ train │     0 │
└───┴─────────┴──────────────────────┴────────┴───────┴───────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Trainable params</span>: 443 K                                                                                            
<span style="font-weight: bold">Non-trainable params</span>: 0                                                                                            
<span style="font-weight: bold">Total params</span>: 443 K                                                                                                
<span style="font-weight: bold">Total estimated model params size (MB)</span>: 1                                                                          
<span style="font-weight: bold">Modules in train mode</span>: 102                                                                                         
<span style="font-weight: bold">Modules in eval mode</span>: 0                                                                                            
<span style="font-weight: bold">Total FLOPs</span>: 0                                                                                                     
</pre>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/shared/data/fprill/aicon_walkthrough/venv/lib64/python3.11/site-packages/pytorch_lightning/trainer/connectors/data_connector.py:378: You have overridden `on_after_batch_transfer` in `LightningModule` but have passed in a `LightningDataModule`. It will use the implementation from `LightningModule` instance.
/shared/data/fprill/aicon_walkthrough/venv/src/anemoi-training/training/src/anemoi/training/losses/scaler_tensor.py:553: UserWarning: Using a non-tuple sequence for multidimensional indexing is deprecated and will be changed in pytorch 2.9; use x[tuple(seq)] instead of x[seq]. In pytorch 2.9 this will be interpreted as tensor index, x[torch.tensor(seq)], which will result either in an error or a different result (Triggered internally at /pytorch/torch/csrc/autograd/python_variable_indexing.cpp:355.)
  x_subset = x[subset_indices] if subset_indices is not None else x
/shared/data/fprill/aicon_walkthrough/venv/src/anemoi-training/training/src/anemoi/training/losses/scaler_tensor.py:576: UserWarning: Using a non-tuple sequence for multidimensional indexing is deprecated and will be changed in pytorch 2.9; use x[tuple(seq)] instead of x[seq]. In pytorch 2.9 this will be interpreted as tensor index, x[torch.tensor(seq)], which will result either in an error or a different result (Triggered internally at /pytorch/torch/csrc/autograd/python_variable_indexing.cpp:355.)
  reshaped_scaler = reshaped_scaler[subset_indices]
/shared/data/fprill/aicon_walkthrough/venv/src/anemoi-training/training/src/anemoi/training/losses/base.py:107: UserWarning: Using a non-tuple sequence for multidimensional indexing is deprecated and will be changed in pytorch 2.9; use x[tuple(seq)] instead of x[seq]. In pytorch 2.9 this will be interpreted as tensor index, x[torch.tensor(seq)], which will result either in an error or a different result (Triggered internally at /pytorch/torch/csrc/autograd/python_variable_indexing.cpp:355.)
  return x[subset_indices]
`Trainer.fit` stopped: `max_steps=200` reached.
</pre></div>
</div>
<img alt="_images/24ad3fd85c7532f4ad1d08c858ac9287fcd8367ee12684686c848770cd3fdebd.png" src="_images/24ad3fd85c7532f4ad1d08c858ac9287fcd8367ee12684686c848770cd3fdebd.png" />
</div>
</div>
<p>Done! Let us examine which objects and models were involved in this training.</p>
</section>
<section id="training-datasets-and-variables">
<h3>Training datasets and variables<a class="headerlink" href="#training-datasets-and-variables" title="Link to this heading">#</a></h3>
<p>At this point, we don’t want to devote too much time to describing the Anemoi training setup, eg. the data range, the optimizer settings, the epochs limit etc. Instead, for these general settings, we refer to <a class="reference external" href="https://lightning.ai/docs/pytorch/stable/">PyTorch Lightning</a> or the <a class="reference external" href="https://anemoi.readthedocs.io/projects/training/en/stable/user-guide/configuring.html">documentation for the Anemoi training setup</a>.
From a “black box” perspective, the above test run has consumed various data files, and created a weights file (“checkpoint”).</p>
<p><img alt="Anemoi overview" src="_images/anemoi_overview.png" /></p>
<p>Almost all of these files are provided as config parameters in the YAML file <code class="docutils literal notranslate"><span class="pre">config_filename</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">omegaconf</span><span class="w"> </span><span class="kn">import</span> <span class="n">OmegaConf</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;Input data:</span>

<span class="s2">ICON mesh (NetCDF):</span>
<span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">icon_mesh</span><span class="o">.</span><span class="n">node_builder</span><span class="o">.</span><span class="n">grid_filename</span><span class="si">=}</span>

<span class="s2">Training interval:</span>
<span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">start</span><span class="si">=}</span><span class="s2"> ... </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">end</span><span class="si">=}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># data files: </span>
<span class="c1"># print(&#39;\n&#39;.join([file for file in cfg.dataloader.training.join]))</span>

<span class="c1"># ---</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;Output directories:</span>

<span class="s2">Directory with checkpoint files:</span>
<span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">hardware</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">checkpoints</span><span class="si">=}</span>

<span class="s2">Log files (including MLFlow):</span>
<span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">hardware</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">base</span><span class="si">=}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Input data:

ICON mesh (NetCDF):
cfg.graph.nodes.icon_mesh.node_builder.grid_filename=&#39;/shared/data/fe1ai/ml-datasets/structure/01_aicon-graph-files/icon_grid_0026_R03B07_G.nc&#39;

Training interval:
cfg.dataloader.training.start=&#39;2022-01-01T00:00:00&#39; ... cfg.dataloader.training.end=&#39;2022-03-03T00:00:00&#39;

Output directories:

Directory with checkpoint files:
cfg.hardware.paths.checkpoints=&#39;output_training/checkpoint/&#39;

Log files (including MLFlow):
cfg.hardware.paths.logs.base=&#39;output_training/mrl3/logs/&#39;
</pre></div>
</div>
</div>
</div>
<p>The subdirectories denoting the output of the current run are auto-generated, if not set in the configuration (for the continuation of runs):</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">run_id</span></code> is a unique identifier associated with a specific training run.</p></li>
<li><p>Additionally, an experiment is associated with a namespace identifier <code class="docutils literal notranslate"><span class="pre">experiment_name</span></code>. This is used by experiment tracking systems, such as <a class="reference external" href="https://mlflow.org/">MLflow</a>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;Unique run ID:</span>
<span class="si">{</span><span class="n">trainer</span><span class="o">.</span><span class="n">run_id</span><span class="si">=}</span>
<span class="s2">            </span>
<span class="s2">Experiment namespaces:</span>
<span class="si">{</span><span class="n">trainer</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">mlflow</span><span class="o">.</span><span class="n">experiment_name</span><span class="si">=}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unique run ID:
trainer.run_id=&#39;0210d057-147f-4d04-8d3f-df4b50044024&#39;

Experiment namespaces:
trainer.config.diagnostics.log.mlflow.experiment_name=&#39;test&#39;
</pre></div>
</div>
</div>
</div>
<p>To understand the meteorological input data, it is worthwhile to inspect a single data file. AICON consumes <strong>gridded reanalysis data</strong>, i.e. a global, consistent representation of the Earth’s (averaged) weather conditions. These datasets are the result of the <strong>ICON DREAM reanalysis</strong> (ICON DREAM = Dual resolution Reanalysis for Emulators, Applications and Monitoring [DWD2024]) and have been converted into the Zarr format. <a class="reference external" href="https://zarr.readthedocs.io/">Zarr</a> is an open-source format for storing large multidimensional arrays in chunked, compressed files optimized for parallel access.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span>
<span class="n">datafile</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">join</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">xarray</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in notebooks */

:root {
  --xr-font-color0: var(
    --jp-content-font-color0,
    var(--pst-color-text-base rgba(0, 0, 0, 1))
  );
  --xr-font-color2: var(
    --jp-content-font-color2,
    var(--pst-color-text-base, rgba(0, 0, 0, 0.54))
  );
  --xr-font-color3: var(
    --jp-content-font-color3,
    var(--pst-color-text-base, rgba(0, 0, 0, 0.38))
  );
  --xr-border-color: var(
    --jp-border-color2,
    hsl(from var(--pst-color-on-background, white) h s calc(l - 10))
  );
  --xr-disabled-color: var(
    --jp-layout-color3,
    hsl(from var(--pst-color-on-background, white) h s calc(l - 40))
  );
  --xr-background-color: var(
    --jp-layout-color0,
    var(--pst-color-on-background, white)
  );
  --xr-background-color-row-even: var(
    --jp-layout-color1,
    hsl(from var(--pst-color-on-background, white) h s calc(l - 5))
  );
  --xr-background-color-row-odd: var(
    --jp-layout-color2,
    hsl(from var(--pst-color-on-background, white) h s calc(l - 15))
  );
}

html[theme="dark"],
html[data-theme="dark"],
body[data-theme="dark"],
body.vscode-dark {
  --xr-font-color0: var(
    --jp-content-font-color0,
    var(--pst-color-text-base, rgba(255, 255, 255, 1))
  );
  --xr-font-color2: var(
    --jp-content-font-color2,
    var(--pst-color-text-base, rgba(255, 255, 255, 0.54))
  );
  --xr-font-color3: var(
    --jp-content-font-color3,
    var(--pst-color-text-base, rgba(255, 255, 255, 0.38))
  );
  --xr-border-color: var(
    --jp-border-color2,
    hsl(from var(--pst-color-on-background, #111111) h s calc(l + 10))
  );
  --xr-disabled-color: var(
    --jp-layout-color3,
    hsl(from var(--pst-color-on-background, #111111) h s calc(l + 40))
  );
  --xr-background-color: var(
    --jp-layout-color0,
    var(--pst-color-on-background, #111111)
  );
  --xr-background-color-row-even: var(
    --jp-layout-color1,
    hsl(from var(--pst-color-on-background, #111111) h s calc(l + 5))
  );
  --xr-background-color-row-odd: var(
    --jp-layout-color2,
    hsl(from var(--pst-color-on-background, #111111) h s calc(l + 15))
  );
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
  line-height: 1.6;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-obj-name,
.xr-group-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-group-name::before {
  content: "📁";
  padding-right: 0.3em;
}

.xr-group-name,
.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 0 20px 0 20px;
  margin-block-start: 0;
  margin-block-end: 0;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: inline-block;
  opacity: 0;
  height: 0;
  margin: 0;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
  border: 2px solid transparent !important;
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:focus + label {
  border: 2px solid var(--xr-font-color0) !important;
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: "►";
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: "▼";
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-top: 4px;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-group-box {
  display: inline-grid;
  grid-template-columns: 0px 20px auto;
  width: 100%;
}

.xr-group-box-vline {
  grid-column-start: 1;
  border-right: 0.2em solid;
  border-color: var(--xr-border-color);
  width: 0px;
}

.xr-group-box-hline {
  grid-column-start: 2;
  grid-row-start: 1;
  height: 1em;
  width: 20px;
  border-bottom: 0.2em solid;
  border-color: var(--xr-border-color);
}

.xr-group-box-contents {
  grid-column-start: 3;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: "(";
}

.xr-dim-list:after {
  content: ")";
}

.xr-dim-list li:not(:last-child):after {
  content: ",";
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  border-color: var(--xr-background-color-row-odd);
  margin-bottom: 0;
  padding-top: 2px;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
  border-color: var(--xr-background-color-row-even);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  border-top: 2px dotted var(--xr-background-color);
  padding-bottom: 20px !important;
  padding-top: 10px !important;
}

.xr-var-attrs-in + label,
.xr-var-data-in + label,
.xr-index-data-in + label {
  padding: 0 1px;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-data > pre,
.xr-index-data > pre,
.xr-var-data > table > tbody > tr {
  background-color: transparent !important;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}

.xr-var-attrs-in:checked + label > .xr-icon-file-text2,
.xr-var-data-in:checked + label > .xr-icon-database,
.xr-index-data-in:checked + label > .xr-icon-database {
  color: var(--xr-font-color0);
  filter: drop-shadow(1px 1px 5px var(--xr-font-color2));
  stroke-width: 0.8px;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt; Size: 3GB
Dimensions:     (variable: 84, time: 724, ensemble: 1, cell: 11520)
Dimensions without coordinates: variable, time, ensemble, cell
Data variables:
    count       (variable) float64 672B dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;
    data        (time, variable, ensemble, cell) float32 3GB dask.array&lt;chunksize=(1, 84, 1, 11520), meta=np.ndarray&gt;
    dates       (time) datetime64[s] 6kB dask.array&lt;chunksize=(724,), meta=np.ndarray&gt;
    has_nans    (variable) object 672B dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;
    latitudes   (cell) float64 92kB dask.array&lt;chunksize=(11520,), meta=np.ndarray&gt;
    longitudes  (cell) float64 92kB dask.array&lt;chunksize=(11520,), meta=np.ndarray&gt;
    maximum     (variable) float64 672B dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;
    mean        (variable) float64 672B dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;
    minimum     (variable) float64 672B dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;
    squares     (variable) float64 672B dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;
    stdev       (variable) float64 672B dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;
    sums        (variable) float64 672B dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;
Attributes: (12/30)
    allow_nans:              False
    attribution:             Deutscher Wetterdienst
    constant_fields:         []
    data_request:            {&#x27;area&#x27;: [None, None, None, None], &#x27;grid&#x27;: None,...
    description:             Test Dataset ICON DREAM Global reanalysis, 13 km...
    end_date:                2022-06-30T18:00:00
    ...                      ...
    total_size:              2028052523
    uuid:                    9ceba822-9940-499b-ab19-99c772561d94
    variables:               [&#x27;P_101&#x27;, &#x27;P_108&#x27;, &#x27;P_112&#x27;, &#x27;P_119&#x27;, &#x27;P_120&#x27;, &#x27;P...
    variables_metadata:      {&#x27;P_101&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;...
    variables_with_nans:     []
    version:                 0.30</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-eeedfce0-bf19-4c89-987a-1439f8e4f019' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-eeedfce0-bf19-4c89-987a-1439f8e4f019' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span>variable</span>: 84</li><li><span>time</span>: 724</li><li><span>ensemble</span>: 1</li><li><span>cell</span>: 11520</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-b094aaa9-d6dc-4308-b4d6-a9d4e48b4f76' class='xr-section-summary-in' type='checkbox'  checked><label for='section-b094aaa9-d6dc-4308-b4d6-a9d4e48b4f76' class='xr-section-summary' >Data variables: <span>(12)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>count</span></div><div class='xr-var-dims'>(variable)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;</div><input id='attrs-490bdd6f-5bde-464e-96c4-f37788ec268f' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-490bdd6f-5bde-464e-96c4-f37788ec268f' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-56e1bdd2-f891-421f-b579-f101374a08e8' class='xr-var-data-in' type='checkbox'><label for='data-56e1bdd2-f891-421f-b579-f101374a08e8' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 672 B </td>
                        <td> 672 B </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (84,) </td>
                        <td> (84,) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 1 chunks in 2 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> float64 numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="170" height="76" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="0" y1="26" x2="120" y2="26" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="26" style="stroke-width:2" />
  <line x1="120" y1="0" x2="120" y2="26" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 120.0,0.0 120.0,26.26679152969952 0.0,26.26679152969952" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="60.000000" y="46.266792" font-size="1.0rem" font-weight="100" text-anchor="middle" >84</text>
  <text x="140.000000" y="13.133396" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,140.000000,13.133396)">1</text>
</svg>
        </td>
    </tr>
</table></div></li><li class='xr-var-item'><div class='xr-var-name'><span>data</span></div><div class='xr-var-dims'>(time, variable, ensemble, cell)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(1, 84, 1, 11520), meta=np.ndarray&gt;</div><input id='attrs-9ace77aa-967a-438f-8ea1-a949a9528db3' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-9ace77aa-967a-438f-8ea1-a949a9528db3' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-a26e939d-714a-476a-93c0-813eb99287c3' class='xr-var-data-in' type='checkbox'><label for='data-a26e939d-714a-476a-93c0-813eb99287c3' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 2.61 GiB </td>
                        <td> 3.69 MiB </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (724, 84, 1, 11520) </td>
                        <td> (1, 84, 1, 11520) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 724 chunks in 2 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> float32 numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="394" height="90" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="35" y2="0" style="stroke-width:2" />
  <line x1="0" y1="25" x2="35" y2="25" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="25" style="stroke-width:2" />
  <line x1="1" y1="0" x2="1" y2="25" />
  <line x1="2" y1="0" x2="2" y2="25" />
  <line x1="3" y1="0" x2="3" y2="25" />
  <line x1="4" y1="0" x2="4" y2="25" />
  <line x1="5" y1="0" x2="5" y2="25" />
  <line x1="6" y1="0" x2="6" y2="25" />
  <line x1="7" y1="0" x2="7" y2="25" />
  <line x1="8" y1="0" x2="8" y2="25" />
  <line x1="10" y1="0" x2="10" y2="25" />
  <line x1="11" y1="0" x2="11" y2="25" />
  <line x1="12" y1="0" x2="12" y2="25" />
  <line x1="13" y1="0" x2="13" y2="25" />
  <line x1="14" y1="0" x2="14" y2="25" />
  <line x1="15" y1="0" x2="15" y2="25" />
  <line x1="16" y1="0" x2="16" y2="25" />
  <line x1="17" y1="0" x2="17" y2="25" />
  <line x1="19" y1="0" x2="19" y2="25" />
  <line x1="20" y1="0" x2="20" y2="25" />
  <line x1="21" y1="0" x2="21" y2="25" />
  <line x1="22" y1="0" x2="22" y2="25" />
  <line x1="23" y1="0" x2="23" y2="25" />
  <line x1="24" y1="0" x2="24" y2="25" />
  <line x1="25" y1="0" x2="25" y2="25" />
  <line x1="26" y1="0" x2="26" y2="25" />
  <line x1="28" y1="0" x2="28" y2="25" />
  <line x1="29" y1="0" x2="29" y2="25" />
  <line x1="30" y1="0" x2="30" y2="25" />
  <line x1="31" y1="0" x2="31" y2="25" />
  <line x1="32" y1="0" x2="32" y2="25" />
  <line x1="33" y1="0" x2="33" y2="25" />
  <line x1="34" y1="0" x2="34" y2="25" />
  <line x1="35" y1="0" x2="35" y2="25" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 35.89298478536107,0.0 35.89298478536107,25.412616514582485 0.0,25.412616514582485" style="fill:#8B4903A0;stroke-width:0"/>

  <!-- Text -->
  <text x="17.946492" y="45.412617" font-size="1.0rem" font-weight="100" text-anchor="middle" >724</text>
  <text x="55.892985" y="12.706308" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,55.892985,12.706308)">1</text>


  <!-- Horizontal lines -->
  <line x1="105" y1="0" x2="119" y2="14" style="stroke-width:2" />
  <line x1="105" y1="25" x2="119" y2="40" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="105" y1="0" x2="105" y2="25" style="stroke-width:2" />
  <line x1="119" y1="14" x2="119" y2="40" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="105.0,0.0 119.9485979497544,14.9485979497544 119.9485979497544,40.36121446433688 105.0,25.412616514582485" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="105" y1="0" x2="225" y2="0" style="stroke-width:2" />
  <line x1="119" y1="14" x2="239" y2="14" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="105" y1="0" x2="119" y2="14" style="stroke-width:2" />
  <line x1="225" y1="0" x2="239" y2="14" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="105.0,0.0 225.0,0.0 239.9485979497544,14.9485979497544 119.9485979497544,14.9485979497544" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="119" y1="14" x2="239" y2="14" style="stroke-width:2" />
  <line x1="119" y1="40" x2="239" y2="40" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="119" y1="14" x2="119" y2="40" style="stroke-width:2" />
  <line x1="239" y1="14" x2="239" y2="40" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="119.9485979497544,14.9485979497544 239.9485979497544,14.9485979497544 239.9485979497544,40.36121446433688 119.9485979497544,40.36121446433688" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="179.948598" y="60.361214" font-size="1.0rem" font-weight="100" text-anchor="middle" >11520</text>
  <text x="259.948598" y="27.654906" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,259.948598,27.654906)">1</text>
  <text x="102.474299" y="52.886915" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(45,102.474299,52.886915)">84</text>
</svg>
        </td>
    </tr>
</table></div></li><li class='xr-var-item'><div class='xr-var-name'><span>dates</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[s]</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(724,), meta=np.ndarray&gt;</div><input id='attrs-ee1cb7d1-8025-4a74-b21f-76aa99692523' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-ee1cb7d1-8025-4a74-b21f-76aa99692523' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-dfd0e509-cc34-4564-ac48-8164ae5766c6' class='xr-var-data-in' type='checkbox'><label for='data-dfd0e509-cc34-4564-ac48-8164ae5766c6' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>_FillValue :</span></dt><dd>1970-01-01T00:00:00</dd></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 5.66 kiB </td>
                        <td> 5.66 kiB </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (724,) </td>
                        <td> (724,) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 1 chunks in 2 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> datetime64[s] numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="170" height="75" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="0" y1="25" x2="120" y2="25" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="25" style="stroke-width:2" />
  <line x1="120" y1="0" x2="120" y2="25" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 120.0,0.0 120.0,25.412616514582485 0.0,25.412616514582485" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="60.000000" y="45.412617" font-size="1.0rem" font-weight="100" text-anchor="middle" >724</text>
  <text x="140.000000" y="12.706308" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,140.000000,12.706308)">1</text>
</svg>
        </td>
    </tr>
</table></div></li><li class='xr-var-item'><div class='xr-var-name'><span>has_nans</span></div><div class='xr-var-dims'>(variable)</div><div class='xr-var-dtype'>object</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;</div><input id='attrs-a79f2419-2e47-45b0-9a29-e90a12d132c0' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-a79f2419-2e47-45b0-9a29-e90a12d132c0' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-f55655b0-1b69-400f-abb6-506f01011828' class='xr-var-data-in' type='checkbox'><label for='data-f55655b0-1b69-400f-abb6-506f01011828' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 672 B </td>
                        <td> 672 B </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (84,) </td>
                        <td> (84,) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 1 chunks in 2 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> object numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="170" height="76" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="0" y1="26" x2="120" y2="26" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="26" style="stroke-width:2" />
  <line x1="120" y1="0" x2="120" y2="26" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 120.0,0.0 120.0,26.26679152969952 0.0,26.26679152969952" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="60.000000" y="46.266792" font-size="1.0rem" font-weight="100" text-anchor="middle" >84</text>
  <text x="140.000000" y="13.133396" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,140.000000,13.133396)">1</text>
</svg>
        </td>
    </tr>
</table></div></li><li class='xr-var-item'><div class='xr-var-name'><span>latitudes</span></div><div class='xr-var-dims'>(cell)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(11520,), meta=np.ndarray&gt;</div><input id='attrs-6e4b2766-a980-49e4-a917-76625a9113cf' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-6e4b2766-a980-49e4-a917-76625a9113cf' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-a85340b3-82a9-48bc-b717-1d42b1c97fcc' class='xr-var-data-in' type='checkbox'><label for='data-a85340b3-82a9-48bc-b717-1d42b1c97fcc' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 90.00 kiB </td>
                        <td> 90.00 kiB </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (11520,) </td>
                        <td> (11520,) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 1 chunks in 2 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> float64 numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="170" height="75" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="0" y1="25" x2="120" y2="25" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="25" style="stroke-width:2" />
  <line x1="120" y1="0" x2="120" y2="25" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 120.0,0.0 120.0,25.412616514582485 0.0,25.412616514582485" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="60.000000" y="45.412617" font-size="1.0rem" font-weight="100" text-anchor="middle" >11520</text>
  <text x="140.000000" y="12.706308" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,140.000000,12.706308)">1</text>
</svg>
        </td>
    </tr>
</table></div></li><li class='xr-var-item'><div class='xr-var-name'><span>longitudes</span></div><div class='xr-var-dims'>(cell)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(11520,), meta=np.ndarray&gt;</div><input id='attrs-e8d402ae-9f54-466e-b4a5-3e799e3008bc' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-e8d402ae-9f54-466e-b4a5-3e799e3008bc' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-99069dee-e18f-4dd0-b053-461d3818c0c5' class='xr-var-data-in' type='checkbox'><label for='data-99069dee-e18f-4dd0-b053-461d3818c0c5' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 90.00 kiB </td>
                        <td> 90.00 kiB </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (11520,) </td>
                        <td> (11520,) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 1 chunks in 2 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> float64 numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="170" height="75" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="0" y1="25" x2="120" y2="25" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="25" style="stroke-width:2" />
  <line x1="120" y1="0" x2="120" y2="25" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 120.0,0.0 120.0,25.412616514582485 0.0,25.412616514582485" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="60.000000" y="45.412617" font-size="1.0rem" font-weight="100" text-anchor="middle" >11520</text>
  <text x="140.000000" y="12.706308" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,140.000000,12.706308)">1</text>
</svg>
        </td>
    </tr>
</table></div></li><li class='xr-var-item'><div class='xr-var-name'><span>maximum</span></div><div class='xr-var-dims'>(variable)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;</div><input id='attrs-9e86f655-5dd6-4381-8622-ae687faa2b15' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-9e86f655-5dd6-4381-8622-ae687faa2b15' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-47753c68-370f-4cc4-bead-f8cf1a302752' class='xr-var-data-in' type='checkbox'><label for='data-47753c68-370f-4cc4-bead-f8cf1a302752' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 672 B </td>
                        <td> 672 B </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (84,) </td>
                        <td> (84,) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 1 chunks in 2 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> float64 numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="170" height="76" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="0" y1="26" x2="120" y2="26" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="26" style="stroke-width:2" />
  <line x1="120" y1="0" x2="120" y2="26" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 120.0,0.0 120.0,26.26679152969952 0.0,26.26679152969952" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="60.000000" y="46.266792" font-size="1.0rem" font-weight="100" text-anchor="middle" >84</text>
  <text x="140.000000" y="13.133396" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,140.000000,13.133396)">1</text>
</svg>
        </td>
    </tr>
</table></div></li><li class='xr-var-item'><div class='xr-var-name'><span>mean</span></div><div class='xr-var-dims'>(variable)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;</div><input id='attrs-2aa27655-d519-4fc9-9a0f-b109eedc9dd0' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-2aa27655-d519-4fc9-9a0f-b109eedc9dd0' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-4a590ff5-7bc5-42f9-92bd-e65a23217b05' class='xr-var-data-in' type='checkbox'><label for='data-4a590ff5-7bc5-42f9-92bd-e65a23217b05' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 672 B </td>
                        <td> 672 B </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (84,) </td>
                        <td> (84,) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 1 chunks in 2 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> float64 numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="170" height="76" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="0" y1="26" x2="120" y2="26" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="26" style="stroke-width:2" />
  <line x1="120" y1="0" x2="120" y2="26" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 120.0,0.0 120.0,26.26679152969952 0.0,26.26679152969952" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="60.000000" y="46.266792" font-size="1.0rem" font-weight="100" text-anchor="middle" >84</text>
  <text x="140.000000" y="13.133396" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,140.000000,13.133396)">1</text>
</svg>
        </td>
    </tr>
</table></div></li><li class='xr-var-item'><div class='xr-var-name'><span>minimum</span></div><div class='xr-var-dims'>(variable)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;</div><input id='attrs-50f7dd8f-3701-478a-b0fe-8138f0cf9dbd' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-50f7dd8f-3701-478a-b0fe-8138f0cf9dbd' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c2dd270e-88ab-4209-b308-33c2a8ba4a36' class='xr-var-data-in' type='checkbox'><label for='data-c2dd270e-88ab-4209-b308-33c2a8ba4a36' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 672 B </td>
                        <td> 672 B </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (84,) </td>
                        <td> (84,) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 1 chunks in 2 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> float64 numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="170" height="76" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="0" y1="26" x2="120" y2="26" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="26" style="stroke-width:2" />
  <line x1="120" y1="0" x2="120" y2="26" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 120.0,0.0 120.0,26.26679152969952 0.0,26.26679152969952" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="60.000000" y="46.266792" font-size="1.0rem" font-weight="100" text-anchor="middle" >84</text>
  <text x="140.000000" y="13.133396" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,140.000000,13.133396)">1</text>
</svg>
        </td>
    </tr>
</table></div></li><li class='xr-var-item'><div class='xr-var-name'><span>squares</span></div><div class='xr-var-dims'>(variable)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;</div><input id='attrs-45185515-1804-468e-a475-89fc8039e796' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-45185515-1804-468e-a475-89fc8039e796' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-5a6310f2-884f-4db4-9c4f-e6d9d137638d' class='xr-var-data-in' type='checkbox'><label for='data-5a6310f2-884f-4db4-9c4f-e6d9d137638d' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 672 B </td>
                        <td> 672 B </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (84,) </td>
                        <td> (84,) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 1 chunks in 2 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> float64 numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="170" height="76" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="0" y1="26" x2="120" y2="26" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="26" style="stroke-width:2" />
  <line x1="120" y1="0" x2="120" y2="26" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 120.0,0.0 120.0,26.26679152969952 0.0,26.26679152969952" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="60.000000" y="46.266792" font-size="1.0rem" font-weight="100" text-anchor="middle" >84</text>
  <text x="140.000000" y="13.133396" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,140.000000,13.133396)">1</text>
</svg>
        </td>
    </tr>
</table></div></li><li class='xr-var-item'><div class='xr-var-name'><span>stdev</span></div><div class='xr-var-dims'>(variable)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;</div><input id='attrs-30fc4909-cbb8-4b16-918b-574c3fa56db7' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-30fc4909-cbb8-4b16-918b-574c3fa56db7' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-f56b7f6c-40a9-40f8-b5ca-0e1ed4ade634' class='xr-var-data-in' type='checkbox'><label for='data-f56b7f6c-40a9-40f8-b5ca-0e1ed4ade634' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 672 B </td>
                        <td> 672 B </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (84,) </td>
                        <td> (84,) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 1 chunks in 2 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> float64 numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="170" height="76" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="0" y1="26" x2="120" y2="26" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="26" style="stroke-width:2" />
  <line x1="120" y1="0" x2="120" y2="26" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 120.0,0.0 120.0,26.26679152969952 0.0,26.26679152969952" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="60.000000" y="46.266792" font-size="1.0rem" font-weight="100" text-anchor="middle" >84</text>
  <text x="140.000000" y="13.133396" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,140.000000,13.133396)">1</text>
</svg>
        </td>
    </tr>
</table></div></li><li class='xr-var-item'><div class='xr-var-name'><span>sums</span></div><div class='xr-var-dims'>(variable)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(84,), meta=np.ndarray&gt;</div><input id='attrs-a9321aab-90c2-47b1-8b69-1922bbc23595' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-a9321aab-90c2-47b1-8b69-1922bbc23595' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-d71aaaf0-dc72-4ba6-8fb7-9df7afb177de' class='xr-var-data-in' type='checkbox'><label for='data-d71aaaf0-dc72-4ba6-8fb7-9df7afb177de' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 672 B </td>
                        <td> 672 B </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (84,) </td>
                        <td> (84,) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 1 chunks in 2 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> float64 numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="170" height="76" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="0" y1="26" x2="120" y2="26" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="26" style="stroke-width:2" />
  <line x1="120" y1="0" x2="120" y2="26" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 120.0,0.0 120.0,26.26679152969952 0.0,26.26679152969952" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="60.000000" y="46.266792" font-size="1.0rem" font-weight="100" text-anchor="middle" >84</text>
  <text x="140.000000" y="13.133396" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,140.000000,13.133396)">1</text>
</svg>
        </td>
    </tr>
</table></div></li></ul></div></li><li class='xr-section-item'><input id='section-a204ab44-e6bd-45b0-8d7b-783dc6cbe1fd' class='xr-section-summary-in' type='checkbox'  ><label for='section-a204ab44-e6bd-45b0-8d7b-783dc6cbe1fd' class='xr-section-summary' >Attributes: <span>(30)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>allow_nans :</span></dt><dd>False</dd><dt><span>attribution :</span></dt><dd>Deutscher Wetterdienst</dd><dt><span>constant_fields :</span></dt><dd>[]</dd><dt><span>data_request :</span></dt><dd>{&#x27;area&#x27;: [None, None, None, None], &#x27;grid&#x27;: None, &#x27;param_level&#x27;: {&#x27;unknown&#x27;: [[&#x27;P&#x27;, 49], [&#x27;P&#x27;, 57], [&#x27;P&#x27;, 64], [&#x27;P&#x27;, 70], [&#x27;P&#x27;, 75], [&#x27;P&#x27;, 79], [&#x27;P&#x27;, 86], [&#x27;P&#x27;, 91], [&#x27;P&#x27;, 96], [&#x27;P&#x27;, 101], [&#x27;P&#x27;, 108], [&#x27;P&#x27;, 112], [&#x27;P&#x27;, 119], [&#x27;P&#x27;, 120], [&#x27;QV&#x27;, 49], [&#x27;QV&#x27;, 57], [&#x27;QV&#x27;, 64], [&#x27;QV&#x27;, 70], [&#x27;QV&#x27;, 75], [&#x27;QV&#x27;, 79], [&#x27;QV&#x27;, 86], [&#x27;QV&#x27;, 91], [&#x27;QV&#x27;, 96], [&#x27;QV&#x27;, 101], [&#x27;QV&#x27;, 108], [&#x27;QV&#x27;, 112], [&#x27;QV&#x27;, 119], [&#x27;QV&#x27;, 120], [&#x27;T&#x27;, 49], [&#x27;T&#x27;, 57], [&#x27;T&#x27;, 64], [&#x27;T&#x27;, 70], [&#x27;T&#x27;, 75], [&#x27;T&#x27;, 79], [&#x27;T&#x27;, 86], [&#x27;T&#x27;, 91], [&#x27;T&#x27;, 96], [&#x27;T&#x27;, 101], [&#x27;T&#x27;, 108], [&#x27;T&#x27;, 112], [&#x27;T&#x27;, 119], [&#x27;T&#x27;, 120], [&#x27;U&#x27;, 49], [&#x27;U&#x27;, 57], [&#x27;U&#x27;, 64], [&#x27;U&#x27;, 70], [&#x27;U&#x27;, 75], [&#x27;U&#x27;, 79], [&#x27;U&#x27;, 86], [&#x27;U&#x27;, 91], [&#x27;U&#x27;, 96], [&#x27;U&#x27;, 101], [&#x27;U&#x27;, 108], [&#x27;U&#x27;, 112], [&#x27;U&#x27;, 119], [&#x27;U&#x27;, 120], [&#x27;V&#x27;, 49], [&#x27;V&#x27;, 57], [&#x27;V&#x27;, 64], [&#x27;V&#x27;, 70], [&#x27;V&#x27;, 75], [&#x27;V&#x27;, 79], [&#x27;V&#x27;, 86], [&#x27;V&#x27;, 91], [&#x27;V&#x27;, 96], [&#x27;V&#x27;, 101], [&#x27;V&#x27;, 108], [&#x27;V&#x27;, 112], [&#x27;V&#x27;, 119], [&#x27;V&#x27;, 120], [&#x27;W&#x27;, 49], [&#x27;W&#x27;, 57], [&#x27;W&#x27;, 64], [&#x27;W&#x27;, 70], [&#x27;W&#x27;, 75], [&#x27;W&#x27;, 79], [&#x27;W&#x27;, 86], [&#x27;W&#x27;, 91], [&#x27;W&#x27;, 96], [&#x27;W&#x27;, 101], [&#x27;W&#x27;, 108], [&#x27;W&#x27;, 112], [&#x27;W&#x27;, 119], [&#x27;W&#x27;, 120]]}, &#x27;param_step&#x27;: {&#x27;unknown&#x27;: [[&#x27;P&#x27;, &#x27;0s&#x27;], [&#x27;QV&#x27;, &#x27;0s&#x27;], [&#x27;T&#x27;, &#x27;0s&#x27;], [&#x27;U&#x27;, &#x27;0s&#x27;], [&#x27;V&#x27;, &#x27;0s&#x27;], [&#x27;W&#x27;, &#x27;0s&#x27;]]}}</dd><dt><span>description :</span></dt><dd>Test Dataset ICON DREAM Global reanalysis, 13 km resolution deterministic 14 model levels</dd><dt><span>end_date :</span></dt><dd>2022-06-30T18:00:00</dd><dt><span>ensemble_dimension :</span></dt><dd>1</dd><dt><span>field_shape :</span></dt><dd>[11520]</dd><dt><span>flatten_grid :</span></dt><dd>True</dd><dt><span>frequency :</span></dt><dd>6h</dd><dt><span>history :</span></dt><dd>[{&#x27;action&#x27;: &#x27;initialised&#x27;, &#x27;timestamp&#x27;: &#x27;2025-10-10T07:43:27.940760&#x27;}, {&#x27;action&#x27;: &#x27;tmp_statistics_initialised&#x27;, &#x27;timestamp&#x27;: &#x27;2025-10-10T07:43:27.946576&#x27;, &#x27;version&#x27;: 3}, {&#x27;action&#x27;: &#x27;init finished&#x27;, &#x27;timestamp&#x27;: &#x27;2025-10-10T07:43:27.962323&#x27;}, {&#x27;action&#x27;: &#x27;compute_statistics_end&#x27;, &#x27;timestamp&#x27;: &#x27;2025-10-10T07:55:50.656293&#x27;}]</dd><dt><span>latest_write_timestamp :</span></dt><dd>2025-10-10T07:55:48.088751</dd><dt><span>licence :</span></dt><dd>unknown</dd><dt><span>missing_dates :</span></dt><dd>[]</dd><dt><span>order_by :</span></dt><dd>[{&#x27;valid_datetime&#x27;: &#x27;ascending&#x27;}, {&#x27;param_level&#x27;: &#x27;ascending&#x27;}, {&#x27;number&#x27;: &#x27;ascending&#x27;}]</dd><dt><span>proj_string :</span></dt><dd>None</dd><dt><span>provenance_load :</span></dt><dd>{&#x27;distribution_names&#x27;: {}, &#x27;git_versions&#x27;: {&#x27;anemoi.datasets&#x27;: {&#x27;git&#x27;: {&#x27;modified_files&#x27;: 2, &#x27;sha1&#x27;: &#x27;9bc2d1736d457c09c042e8db45ac587c94e75218&#x27;, &#x27;untracked_files&#x27;: 0}}, &#x27;anemoi.utils&#x27;: {&#x27;git&#x27;: {&#x27;modified_files&#x27;: 0, &#x27;sha1&#x27;: &#x27;9c54894364f136c1dc53bfbaea2ad92c28fa768a&#x27;, &#x27;untracked_files&#x27;: 0}}}, &#x27;module_versions&#x27;: {&#x27;_cffi_backend&#x27;: &#x27;2.0.0&#x27;, &#x27;_csv&#x27;: &#x27;1.0&#x27;, &#x27;_ctypes&#x27;: &#x27;1.1.0&#x27;, &#x27;_decimal&#x27;: &#x27;1.70&#x27;, &#x27;anemoi.datasets&#x27;: &#x27;0.5.27.dev24+g9bc2d1736&#x27;, &#x27;anemoi.transform&#x27;: &#x27;0.1.16&#x27;, &#x27;anemoi.utils&#x27;: &#x27;0.4.37.dev1+gaa20fa8b0&#x27;, &#x27;aniso8601&#x27;: &#x27;10.0.1&#x27;, &#x27;argparse&#x27;: &#x27;1.1&#x27;, &#x27;array_api_compat&#x27;: &#x27;1.12.0&#x27;, &#x27;attr&#x27;: &#x27;25.3.0&#x27;, &#x27;cachetools&#x27;: &#x27;6.2.0&#x27;, &#x27;cartopy&#x27;: &#x27;0.25.0&#x27;, &#x27;certifi&#x27;: &#x27;2025.08.03&#x27;, &#x27;cffi&#x27;: &#x27;2.0.0&#x27;, &#x27;cfgrib&#x27;: &#x27;0.9.15.0&#x27;, &#x27;cftime&#x27;: &#x27;1.6.4.post1&#x27;, &#x27;charset_normalizer&#x27;: &#x27;3.4.3&#x27;, &#x27;cloudpickle&#x27;: &#x27;3.1.1&#x27;, &#x27;csv&#x27;: &#x27;1.0&#x27;, &#x27;ctypes&#x27;: &#x27;1.1.0&#x27;, &#x27;dask&#x27;: &#x27;2025.9.1&#x27;, &#x27;dateutil&#x27;: &#x27;2.9.0.post0&#x27;, &#x27;decimal&#x27;: &#x27;1.70&#x27;, &#x27;deprecated&#x27;: &#x27;1.2.18&#x27;, &#x27;deprecation&#x27;: &#x27;2.1.0&#x27;, &#x27;earthkit&#x27;: &#x27;-1&#x27;, &#x27;eccodes&#x27;: &#x27;2.43.0&#x27;, &#x27;eccodeslib&#x27;: &#x27;2.43.0&#x27;, &#x27;eckitlib&#x27;: &#x27;1.31.4&#x27;, &#x27;entrypoints&#x27;: &#x27;0.4&#x27;, &#x27;fasteners&#x27;: &#x27;0.20&#x27;, &#x27;fckitlib&#x27;: &#x27;0.14.0&#x27;, &#x27;findlibs&#x27;: &#x27;0.1.2&#x27;, &#x27;fsspec&#x27;: &#x27;2025.9.0&#x27;, &#x27;gribapi&#x27;: &#x27;2.43.0&#x27;, &#x27;idna&#x27;: &#x27;3.10&#x27;, &#x27;ipaddress&#x27;: &#x27;1.0&#x27;, &#x27;jinja2&#x27;: &#x27;3.1.6&#x27;, &#x27;json&#x27;: &#x27;2.0.9&#x27;, &#x27;kerchunk&#x27;: &#x27;0.2.7&#x27;, &#x27;logging&#x27;: &#x27;0.5.1.2&#x27;, &#x27;markupsafe&#x27;: &#x27;3.0.2&#x27;, &#x27;multiurl&#x27;: &#x27;0.3.7&#x27;, &#x27;netCDF4&#x27;: &#x27;1.7.2&#x27;, &#x27;numcodecs&#x27;: &#x27;0.15.1&#x27;, &#x27;numpy&#x27;: &#x27;2.3.3&#x27;, &#x27;packaging&#x27;: &#x27;24.2&#x27;, &#x27;pandas&#x27;: &#x27;2.3.2&#x27;, &#x27;platform&#x27;: &#x27;1.0.8&#x27;, &#x27;pycparser&#x27;: &#x27;2.23&#x27;, &#x27;pyproj&#x27;: &#x27;3.7.2&#x27;, &#x27;pytz&#x27;: &#x27;2024.2&#x27;, &#x27;re&#x27;: &#x27;2.2.1&#x27;, &#x27;requests&#x27;: &#x27;2.32.5&#x27;, &#x27;scipy&#x27;: &#x27;1.16.2&#x27;, &#x27;semantic_version&#x27;: &#x27;2.10.0&#x27;, &#x27;shapefile&#x27;: &#x27;2.3.1&#x27;, &#x27;shapely&#x27;: &#x27;2.1.2&#x27;, &#x27;six&#x27;: &#x27;1.17.0&#x27;, &#x27;tlz&#x27;: &#x27;1.0.0&#x27;, &#x27;toolz&#x27;: &#x27;1.0.0&#x27;, &#x27;tqdm&#x27;: &#x27;4.67.1&#x27;, &#x27;urllib3&#x27;: &#x27;2.5.0&#x27;, &#x27;wrapt&#x27;: &#x27;1.17.3&#x27;, &#x27;xarray&#x27;: &#x27;2025.9.0&#x27;, &#x27;yaml&#x27;: &#x27;6.0.2&#x27;, &#x27;zarr&#x27;: &#x27;2.18.4&#x27;, &#x27;zlib&#x27;: &#x27;1.0&#x27;}, &#x27;python&#x27;: &#x27;3.11.11&#x27;, &#x27;time&#x27;: &#x27;2025-10-10T07:49:00.307158&#x27;}</dd><dt><span>recipe :</span></dt><dd>{&#x27;attribution&#x27;: &#x27;Deutscher Wetterdienst&#x27;, &#x27;build&#x27;: {&#x27;group_by&#x27;: &#x27;daily&#x27;, &#x27;use_grib_paramid&#x27;: False, &#x27;variable_naming&#x27;: &#x27;{param}_{level}&#x27;}, &#x27;common&#x27;: {&#x27;grid_definition&#x27;: {&#x27;icon&#x27;: {&#x27;path&#x27;: &#x27;/.../icon_grid_0026_R03B07_G.nc&#x27;, &#x27;refinement_level_c&#x27;: 7}}, &#x27;link1&#x27;: &#x27;/.../{date:strftimedelta(+0h;%Y%m%d%H)}/an_R03B07.{date:strftime(%Y%m%d%H)}&#x27;, &#x27;link2&#x27;: &#x27;/.../{date:strftimedelta(+3h;%Y%m%d%H)}/fc_R03B07_rea_ml.{date:strftime(%Y%m%d%H)}&#x27;, &#x27;link3&#x27;: &#x27;/.../{date:strftimedelta(+0h;%Y%m%d%H)}/fc_R03B07_rea_ml.{date:strftime(%Y%m%d%H)}&#x27;, &#x27;link4&#x27;: &#x27;/.../{date:strftimedelta(+3h;%Y%m%d%H)}/fc_R03B07_rea_pl.{date:strftime(%Y%m%d%H)}&#x27;, &#x27;refinement_level_c&#x27;: 3, &#x27;sfc_flavour&#x27;: [[{}, {&#x27;levelist&#x27;: None, &#x27;levtype&#x27;: &#x27;sfc&#x27;}]]}, &#x27;dates&#x27;: {&#x27;end&#x27;: &#x27;2022-06-30T18:00:00+00:00&#x27;, &#x27;frequency&#x27;: &#x27;6h&#x27;, &#x27;group_by&#x27;: &#x27;daily&#x27;, &#x27;start&#x27;: &#x27;2022-01-01T00:00:00+00:00&#x27;}, &#x27;description&#x27;: &#x27;Test Dataset ICON DREAM Global reanalysis, 13 km resolution deterministic 14 model levels&#x27;, &#x27;env&#x27;: {&#x27;ECCODES_DEFINITION_PATH&#x27;: &#x27;/.../definitions&#x27;, &#x27;ECCODES_DIR&#x27;: &#x27;/.../python&#x27;}, &#x27;input&#x27;: {&#x27;pipe&#x27;: [{&#x27;join&#x27;: [{&#x27;grib&#x27;: {&#x27;grid_definition&#x27;: {&#x27;icon&#x27;: {&#x27;path&#x27;: &#x27;/.../icon_grid_0026_R03B07_G.nc&#x27;, &#x27;refinement_level_c&#x27;: 7}}, &#x27;level&#x27;: [49, 57, 64, 70, 75, 79, 86, 91, 96, 101, 108, 112, 119, 120], &#x27;param&#x27;: [&#x27;P&#x27;, &#x27;T&#x27;, &#x27;U&#x27;, &#x27;V&#x27;, &#x27;QV&#x27;], &#x27;path&#x27;: &#x27;/.../{date:strftimedelta(+3h;%Y%m%d%H)}/fc_R03B07_rea_ml.{date:strftime(%Y%m%d%H)}&#x27;, &#x27;typeOfLevel&#x27;: &#x27;generalVerticalLayer&#x27;}}, {&#x27;grib&#x27;: {&#x27;grid_definition&#x27;: {&#x27;icon&#x27;: {&#x27;path&#x27;: &#x27;/.../icon_grid_0026_R03B07_G.nc&#x27;, &#x27;refinement_level_c&#x27;: 7}}, &#x27;level&#x27;: [49, 57, 64, 70, 75, 79, 86, 91, 96, 101, 108, 112, 119, 120], &#x27;param&#x27;: [&#x27;W&#x27;], &#x27;path&#x27;: &#x27;/.../{date:strftimedelta(+3h;%Y%m%d%H)}/fc_R03B07_rea_ml.{date:strftime(%Y%m%d%H)}&#x27;, &#x27;typeOfLevel&#x27;: &#x27;generalVertical&#x27;}}]}, {&#x27;icon_refinement_level&#x27;: {&#x27;grid&#x27;: &#x27;/.../icon_grid_0026_R03B07_G.nc&#x27;, &#x27;refinement_level_c&#x27;: 3}}]}, &#x27;licence&#x27;: &#x27;unknown&#x27;, &#x27;name&#x27;: &#x27;dwd-dream-archive-R03B03-20220101-20220701-6h-v1-ml14&#x27;, &#x27;output&#x27;: {&#x27;chunking&#x27;: {&#x27;dates&#x27;: 1, &#x27;ensembles&#x27;: 1}, &#x27;dtype&#x27;: &#x27;float32&#x27;, &#x27;ensemble_dimension&#x27;: 2, &#x27;flatten_grid&#x27;: True, &#x27;order_by&#x27;: [{&#x27;valid_datetime&#x27;: &#x27;ascending&#x27;}, {&#x27;param_level&#x27;: &#x27;ascending&#x27;}, {&#x27;number&#x27;: &#x27;ascending&#x27;}], &#x27;remapping&#x27;: {&#x27;param_level&#x27;: &#x27;{param}_{level}&#x27;}, &#x27;statistics&#x27;: &#x27;param_level&#x27;}, &#x27;statistics&#x27;: {&#x27;allow_nans&#x27;: []}, &#x27;verbose&#x27;: False}</dd><dt><span>remapping :</span></dt><dd>{&#x27;param_level&#x27;: &#x27;{param}_{level}&#x27;}</dd><dt><span>resolution :</span></dt><dd>mrl3</dd><dt><span>start_date :</span></dt><dd>2022-01-01T00:00:00</dd><dt><span>statistics_end_date :</span></dt><dd>2022-05-25T12:00:00</dd><dt><span>statistics_start_date :</span></dt><dd>2022-01-01T00:00:00</dd><dt><span>total_number_of_files :</span></dt><dd>761</dd><dt><span>total_size :</span></dt><dd>2028052523</dd><dt><span>uuid :</span></dt><dd>9ceba822-9940-499b-ab19-99c772561d94</dd><dt><span>variables :</span></dt><dd>[&#x27;P_101&#x27;, &#x27;P_108&#x27;, &#x27;P_112&#x27;, &#x27;P_119&#x27;, &#x27;P_120&#x27;, &#x27;P_49&#x27;, &#x27;P_57&#x27;, &#x27;P_64&#x27;, &#x27;P_70&#x27;, &#x27;P_75&#x27;, &#x27;P_79&#x27;, &#x27;P_86&#x27;, &#x27;P_91&#x27;, &#x27;P_96&#x27;, &#x27;QV_101&#x27;, &#x27;QV_108&#x27;, &#x27;QV_112&#x27;, &#x27;QV_119&#x27;, &#x27;QV_120&#x27;, &#x27;QV_49&#x27;, &#x27;QV_57&#x27;, &#x27;QV_64&#x27;, &#x27;QV_70&#x27;, &#x27;QV_75&#x27;, &#x27;QV_79&#x27;, &#x27;QV_86&#x27;, &#x27;QV_91&#x27;, &#x27;QV_96&#x27;, &#x27;T_101&#x27;, &#x27;T_108&#x27;, &#x27;T_112&#x27;, &#x27;T_119&#x27;, &#x27;T_120&#x27;, &#x27;T_49&#x27;, &#x27;T_57&#x27;, &#x27;T_64&#x27;, &#x27;T_70&#x27;, &#x27;T_75&#x27;, &#x27;T_79&#x27;, &#x27;T_86&#x27;, &#x27;T_91&#x27;, &#x27;T_96&#x27;, &#x27;U_101&#x27;, &#x27;U_108&#x27;, &#x27;U_112&#x27;, &#x27;U_119&#x27;, &#x27;U_120&#x27;, &#x27;U_49&#x27;, &#x27;U_57&#x27;, &#x27;U_64&#x27;, &#x27;U_70&#x27;, &#x27;U_75&#x27;, &#x27;U_79&#x27;, &#x27;U_86&#x27;, &#x27;U_91&#x27;, &#x27;U_96&#x27;, &#x27;V_101&#x27;, &#x27;V_108&#x27;, &#x27;V_112&#x27;, &#x27;V_119&#x27;, &#x27;V_120&#x27;, &#x27;V_49&#x27;, &#x27;V_57&#x27;, &#x27;V_64&#x27;, &#x27;V_70&#x27;, &#x27;V_75&#x27;, &#x27;V_79&#x27;, &#x27;V_86&#x27;, &#x27;V_91&#x27;, &#x27;V_96&#x27;, &#x27;W_101&#x27;, &#x27;W_108&#x27;, &#x27;W_112&#x27;, &#x27;W_119&#x27;, &#x27;W_120&#x27;, &#x27;W_49&#x27;, &#x27;W_57&#x27;, &#x27;W_64&#x27;, &#x27;W_70&#x27;, &#x27;W_75&#x27;, &#x27;W_79&#x27;, &#x27;W_86&#x27;, &#x27;W_91&#x27;, &#x27;W_96&#x27;]</dd><dt><span>variables_metadata :</span></dt><dd>{&#x27;P_101&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 101, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;P_108&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 108, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;P_112&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 112, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;P_119&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 119, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;P_120&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 120, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;P_49&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 49, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;P_57&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 57, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;P_64&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 64, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;P_70&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 70, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;P_75&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 75, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;P_79&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 79, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;P_86&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 86, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;P_91&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 91, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;P_96&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 96, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;P&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_101&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 101, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_108&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 108, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_112&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 112, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_119&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 119, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_120&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 120, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_49&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 49, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_57&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 57, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_64&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 64, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_70&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 70, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_75&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 75, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_79&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 79, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_86&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 86, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_91&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 91, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;QV_96&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 96, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;QV&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_101&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 101, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_108&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 108, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_112&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 112, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_119&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 119, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_120&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 120, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_49&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 49, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_57&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 57, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_64&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 64, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_70&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 70, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_75&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 75, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_79&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 79, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_86&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 86, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_91&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 91, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;T_96&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 96, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;T&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_101&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 101, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_108&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 108, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_112&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 112, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_119&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 119, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_120&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 120, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_49&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 49, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_57&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 57, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_64&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 64, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_70&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 70, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_75&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 75, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_79&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 79, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_86&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 86, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_91&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 91, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;U_96&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 96, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;U&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_101&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 101, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_108&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 108, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_112&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 112, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_119&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 119, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_120&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 120, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_49&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 49, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_57&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 57, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_64&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 64, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_70&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 70, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_75&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 75, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_79&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 79, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_86&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 86, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_91&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 91, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;V_96&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 96, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;V&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_101&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 101, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_108&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 108, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_112&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 112, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_119&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 119, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_120&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 120, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_49&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 49, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_57&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 57, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_64&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 64, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_70&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 70, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_75&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 75, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_79&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 79, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_86&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 86, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_91&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 91, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}, &#x27;W_96&#x27;: {&#x27;mars&#x27;: {&#x27;date&#x27;: 20220101, &#x27;levelist&#x27;: 96, &#x27;levtype&#x27;: &#x27;unknown&#x27;, &#x27;param&#x27;: &#x27;W&#x27;, &#x27;step&#x27;: &#x27;0s&#x27;, &#x27;time&#x27;: 0}}}</dd><dt><span>variables_with_nans :</span></dt><dd>[]</dd><dt><span>version :</span></dt><dd>0.30</dd></dl></div></li></ul></div></div></div></div>
</div>
<p>From this result we can see that different fields from various levels are combined to form the <strong>feature vector</strong> of the model.
We can also directly access the dataset using the <code class="docutils literal notranslate"><span class="pre">zarr</span></code> Python package and separate variable names and levels:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">jupyter_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">split_string</span><span class="p">,</span> <span class="n">parse_shortname_def</span><span class="p">,</span> <span class="n">parse_name_def</span><span class="p">,</span> <span class="n">find_long_name_by_shortname</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>

<span class="n">zarr_group_in</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">var_list_in</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">zarr_group_in</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">])</span>

<span class="c1"># get a unique list of GRIB2 shortNames:</span>
<span class="n">var_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">split_string</span><span class="p">(</span><span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_list_in</span><span class="p">]</span>
<span class="n">vars_in</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span><span class="n">var_data</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

<span class="c1"># get a list of levels for each variale:</span>
<span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">vars_in</span><span class="p">:</span>
    <span class="n">level_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span>
            <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_list_in</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">:=</span> <span class="n">split_string</span><span class="p">(</span><span class="n">var</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">varname</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">vars_in</span>
    <span class="p">]</span>

<span class="c1"># get GRIB2 info on the variable:</span>
<span class="n">defpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;ECCODES_DEFINITION_PATH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">grib2_dict</span> <span class="o">=</span> <span class="p">[(</span><span class="n">parse_shortname_def</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/grib2/shortName.def&quot;</span><span class="p">),</span> <span class="n">parse_name_def</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/grib2/name.def&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">defpath</span><span class="p">]</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;shortName&#39;</span><span class="p">:</span> <span class="n">vars_in</span><span class="p">,</span>
    <span class="s1">&#39;Name&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="n">find_long_name_by_shortname</span><span class="p">(</span><span class="n">grib2_dict</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vars_in</span><span class="p">],</span>
    <span class="s1">&#39;Levels&#39;</span><span class="p">:</span> <span class="n">level_data</span>
<span class="p">}</span>

<span class="c1"># print as a table:</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jupyter_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">pandas_table_style</span>
<span class="n">display</span><span class="p">(</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">pandas_table_style</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_c5455 th {
  text-align: left;
  font-size: 12pt;
}
#T_c5455 td {
  text-align: left;
  font-size: 12pt;
}
</style>
<table id="T_c5455">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_c5455_level0_col0" class="col_heading level0 col0" >shortName</th>
      <th id="T_c5455_level0_col1" class="col_heading level0 col1" >Name</th>
      <th id="T_c5455_level0_col2" class="col_heading level0 col2" >Levels</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_c5455_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_c5455_row0_col0" class="data row0 col0" >P</td>
      <td id="T_c5455_row0_col1" class="data row0 col1" >Pressure</td>
      <td id="T_c5455_row0_col2" class="data row0 col2" >[101, 108, 112, 119, 120, 49, 57, 64, 70, 75, 79, 86, 91, 96]</td>
    </tr>
    <tr>
      <th id="T_c5455_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_c5455_row1_col0" class="data row1 col0" >QV</td>
      <td id="T_c5455_row1_col1" class="data row1 col1" >Specific Humidity</td>
      <td id="T_c5455_row1_col2" class="data row1 col2" >[101, 108, 112, 119, 120, 49, 57, 64, 70, 75, 79, 86, 91, 96]</td>
    </tr>
    <tr>
      <th id="T_c5455_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_c5455_row2_col0" class="data row2 col0" >T</td>
      <td id="T_c5455_row2_col1" class="data row2 col1" >Temperature</td>
      <td id="T_c5455_row2_col2" class="data row2 col2" >[101, 108, 112, 119, 120, 49, 57, 64, 70, 75, 79, 86, 91, 96]</td>
    </tr>
    <tr>
      <th id="T_c5455_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_c5455_row3_col0" class="data row3 col0" >U</td>
      <td id="T_c5455_row3_col1" class="data row3 col1" >U-Component of Wind</td>
      <td id="T_c5455_row3_col2" class="data row3 col2" >[101, 108, 112, 119, 120, 49, 57, 64, 70, 75, 79, 86, 91, 96]</td>
    </tr>
    <tr>
      <th id="T_c5455_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_c5455_row4_col0" class="data row4 col0" >V</td>
      <td id="T_c5455_row4_col1" class="data row4 col1" >V-Component of Wind</td>
      <td id="T_c5455_row4_col2" class="data row4 col2" >[101, 108, 112, 119, 120, 49, 57, 64, 70, 75, 79, 86, 91, 96]</td>
    </tr>
    <tr>
      <th id="T_c5455_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_c5455_row5_col0" class="data row5 col0" >W</td>
      <td id="T_c5455_row5_col1" class="data row5 col1" >Vertical Velocity (Geometric) (w)</td>
      <td id="T_c5455_row5_col2" class="data row5 col2" >[101, 108, 112, 119, 120, 49, 57, 64, 70, 75, 79, 86, 91, 96]</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Assuming a standard atmosphere and using ICON’s list of <strong>SLEVE coordinate level heights</strong>, we can visualize this together with the currently used AIFS pressure levels from ECMWF [Lang2024] as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ICON output of the SLEVE coordinate setup:</span>
<span class="n">vct_a</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">75000.000</span><span class="p">,</span> <span class="mf">73420.604</span><span class="p">,</span> <span class="mf">71869.610</span><span class="p">,</span> <span class="mf">70328.192</span><span class="p">,</span> <span class="mf">68805.917</span><span class="p">,</span> <span class="mf">67302.897</span><span class="p">,</span> <span class="mf">65819.234</span><span class="p">,</span> <span class="mf">64355.018</span><span class="p">,</span> <span class="mf">62910.329</span><span class="p">,</span> <span class="mf">61485.239</span><span class="p">,</span>
    <span class="mf">60079.812</span><span class="p">,</span> <span class="mf">58694.107</span><span class="p">,</span> <span class="mf">57328.172</span><span class="p">,</span> <span class="mf">55982.053</span><span class="p">,</span> <span class="mf">54655.788</span><span class="p">,</span> <span class="mf">53349.411</span><span class="p">,</span> <span class="mf">52062.951</span><span class="p">,</span> <span class="mf">50796.435</span><span class="p">,</span> <span class="mf">49549.882</span><span class="p">,</span> <span class="mf">48323.311</span><span class="p">,</span>
    <span class="mf">47116.737</span><span class="p">,</span> <span class="mf">45930.172</span><span class="p">,</span> <span class="mf">44763.626</span><span class="p">,</span> <span class="mf">43617.107</span><span class="p">,</span> <span class="mf">42490.621</span><span class="p">,</span> <span class="mf">41384.171</span><span class="p">,</span> <span class="mf">40297.761</span><span class="p">,</span> <span class="mf">39231.393</span><span class="p">,</span> <span class="mf">38185.067</span><span class="p">,</span> <span class="mf">37158.783</span><span class="p">,</span>
    <span class="mf">36152.542</span><span class="p">,</span> <span class="mf">35166.342</span><span class="p">,</span> <span class="mf">34200.183</span><span class="p">,</span> <span class="mf">33254.064</span><span class="p">,</span> <span class="mf">32327.985</span><span class="p">,</span> <span class="mf">31421.947</span><span class="p">,</span> <span class="mf">30535.948</span><span class="p">,</span> <span class="mf">29669.993</span><span class="p">,</span> <span class="mf">28824.082</span><span class="p">,</span> <span class="mf">27998.221</span><span class="p">,</span>
    <span class="mf">27192.413</span><span class="p">,</span> <span class="mf">26406.667</span><span class="p">,</span> <span class="mf">25640.990</span><span class="p">,</span> <span class="mf">24895.393</span><span class="p">,</span> <span class="mf">24169.889</span><span class="p">,</span> <span class="mf">23463.917</span><span class="p">,</span> <span class="mf">22770.331</span><span class="p">,</span> <span class="mf">22096.568</span><span class="p">,</span> <span class="mf">21435.487</span><span class="p">,</span> <span class="mf">20795.107</span><span class="p">,</span>
    <span class="mf">20175.457</span><span class="p">,</span> <span class="mf">19576.575</span><span class="p">,</span> <span class="mf">18998.498</span><span class="p">,</span> <span class="mf">18441.271</span><span class="p">,</span> <span class="mf">17908.405</span><span class="p">,</span> <span class="mf">17400.463</span><span class="p">,</span> <span class="mf">16920.113</span><span class="p">,</span> <span class="mf">16467.114</span><span class="p">,</span> <span class="mf">16039.909</span><span class="p">,</span> <span class="mf">15637.031</span><span class="p">,</span>
    <span class="mf">15257.093</span><span class="p">,</span> <span class="mf">14898.789</span><span class="p">,</span> <span class="mf">14560.888</span><span class="p">,</span> <span class="mf">14242.227</span><span class="p">,</span> <span class="mf">13933.170</span><span class="p">,</span> <span class="mf">13633.170</span><span class="p">,</span> <span class="mf">13333.170</span><span class="p">,</span> <span class="mf">13033.170</span><span class="p">,</span> <span class="mf">12733.170</span><span class="p">,</span> <span class="mf">12433.170</span><span class="p">,</span>
    <span class="mf">12133.170</span><span class="p">,</span> <span class="mf">11833.170</span><span class="p">,</span> <span class="mf">11533.170</span><span class="p">,</span> <span class="mf">11233.170</span><span class="p">,</span> <span class="mf">10933.170</span><span class="p">,</span> <span class="mf">10633.170</span><span class="p">,</span> <span class="mf">10333.170</span><span class="p">,</span> <span class="mf">10033.170</span><span class="p">,</span> <span class="mf">9733.170</span><span class="p">,</span> <span class="mf">9433.170</span><span class="p">,</span>
    <span class="mf">9133.170</span><span class="p">,</span> <span class="mf">8833.170</span><span class="p">,</span> <span class="mf">8533.170</span><span class="p">,</span> <span class="mf">8233.170</span><span class="p">,</span> <span class="mf">7933.170</span><span class="p">,</span> <span class="mf">7633.170</span><span class="p">,</span> <span class="mf">7333.170</span><span class="p">,</span> <span class="mf">7033.170</span><span class="p">,</span> <span class="mf">6733.170</span><span class="p">,</span> <span class="mf">6433.170</span><span class="p">,</span>
    <span class="mf">6133.170</span><span class="p">,</span> <span class="mf">5833.170</span><span class="p">,</span> <span class="mf">5533.170</span><span class="p">,</span> <span class="mf">5233.170</span><span class="p">,</span> <span class="mf">4933.170</span><span class="p">,</span> <span class="mf">4633.170</span><span class="p">,</span> <span class="mf">4333.170</span><span class="p">,</span> <span class="mf">4033.170</span><span class="p">,</span> <span class="mf">3735.917</span><span class="p">,</span> <span class="mf">3448.582</span><span class="p">,</span>
    <span class="mf">3171.241</span><span class="p">,</span> <span class="mf">2903.980</span><span class="p">,</span> <span class="mf">2646.890</span><span class="p">,</span> <span class="mf">2400.076</span><span class="p">,</span> <span class="mf">2163.652</span><span class="p">,</span> <span class="mf">1937.746</span><span class="p">,</span> <span class="mf">1722.498</span><span class="p">,</span> <span class="mf">1518.070</span><span class="p">,</span> <span class="mf">1324.640</span><span class="p">,</span> <span class="mf">1142.413</span><span class="p">,</span>
    <span class="mf">971.624</span><span class="p">,</span> <span class="mf">812.540</span><span class="p">,</span> <span class="mf">665.478</span><span class="p">,</span> <span class="mf">530.811</span><span class="p">,</span> <span class="mf">408.988</span><span class="p">,</span> <span class="mf">300.565</span><span class="p">,</span> <span class="mf">206.253</span><span class="p">,</span> <span class="mf">126.999</span><span class="p">,</span> <span class="mf">64.166</span><span class="p">,</span> <span class="mf">20.000</span><span class="p">,</span> <span class="mf">0.000</span>
<span class="p">]</span>

<span class="c1"># AIFS:</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">pressure_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">850</span><span class="p">,</span> <span class="mi">925</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mtransforms</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ussa1976</span>

<span class="n">heights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100001</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ussa1976</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">heights</span><span class="p">)</span>
<span class="n">pressure_hPa</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="mf">100.0</span>
<span class="n">altitude_m</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">values</span>

<span class="n">altitude_marks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">pressure_levels</span><span class="p">,</span> <span class="n">pressure_hPa</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">altitude_m</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">levels_in</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">level_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">highlight_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">levels_in</span><span class="p">]</span>
<span class="n">color_sel</span> <span class="o">=</span> <span class="s1">&#39;#3db998&#39;</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pressure_hPa</span><span class="p">,</span> <span class="n">altitude_m</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pressure_levels</span><span class="p">,</span> <span class="n">altitude_marks</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AIFS pressure levels, 2024&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pressure_levels</span><span class="p">,</span> <span class="n">altitude_marks</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

<span class="n">topmost_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">highlight_indices</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">vct_a</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vct_a</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">highlight_indices</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_sel</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">mtransforms</span><span class="o">.</span><span class="n">blended_transform_factory</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;ICON Level </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">topmost_idx</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;Level </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_sel</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Thin gray line</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pressure [hPa]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Height above mean sea level [m]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pressure vs. Height above Mean Sea Level&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30000</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;1976 Standard Atmosphere&quot;</span><span class="p">,</span> <span class="s2">&quot;AIFS pressure levels, 2024&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;AICON_levels.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c3c169078e9dad577186eee04889bda91f471c716e2dbe93f07ab4999012f811.png" src="_images/c3c169078e9dad577186eee04889bda91f471c716e2dbe93f07ab4999012f811.png" />
</div>
</div>
<p>The next input dataset contains the “forcings”. <strong>Forcing variables</strong> are input variables that provide external information to the model but are not predicted by the model itself.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>
<span class="n">forcings_file</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">join</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">zarr_group_in</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">forcings_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

<span class="n">var_list_in</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">zarr_group_in</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">])</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pprint</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">var_list_in</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;EMIS_RAD&#39;,
 &#39;FR_LAKE&#39;,
 &#39;FR_LAND&#39;,
 &#39;HSURF&#39;,
 &#39;SSO_GAMMA&#39;,
 &#39;SSO_SIGMA&#39;,
 &#39;SSO_STDH&#39;,
 &#39;SSO_THETA&#39;,
 &#39;Z0&#39;,
 &#39;cos_julian_day&#39;,
 &#39;cos_latitude&#39;,
 &#39;cos_local_time&#39;,
 &#39;cos_longitude&#39;,
 &#39;insolation&#39;,
 &#39;sin_julian_day&#39;,
 &#39;sin_latitude&#39;,
 &#39;sin_local_time&#39;,
 &#39;sin_longitude&#39;]
</pre></div>
</div>
</div>
</div>
<p>If you want to create your own custom Zarr datasets, the <code class="docutils literal notranslate"><span class="pre">anemoi-datasets</span></code> package provides the command-line tool</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>anemoi-datasets<span class="w"> </span>-d<span class="w"> </span>create<span class="w"> </span>my-data.yaml<span class="w"> </span>test_out.zarr
</pre></div>
</div>
<p>However, the specific settings of the YAML configuration file, named <code class="docutils literal notranslate"><span class="pre">my-data.yaml</span></code>, will not be covered in this specific Jupyter notebook.</p>
</section>
<section id="checkpoint-files">
<h3>Checkpoint files<a class="headerlink" href="#checkpoint-files" title="Link to this heading">#</a></h3>
<p>The <strong>checkpoint directory</strong> contains both, a checkpoint for training continuation (<code class="docutils literal notranslate"><span class="pre">last.ckpt</span></code>) and the inference checkpoint for prediction runs (<code class="docutils literal notranslate"><span class="pre">inference-last.ckpt</span></code>). In PyTorch Lightning, <code class="docutils literal notranslate"><span class="pre">last.ckpt</span></code> is the latest checkpoint file, but older checkpoints can be retained. Furthermore, Anemoi allows fine-grained control over the checkpointing frequency:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>every_n_minutes:
  save_frequency: 30
  num_models_saved: 3
every_n_epochs:
  save_frequency: 1
  num_models_saved: -1
every_n_train_steps:
  save_frequency: 20
  num_models_saved: 0
</pre></div>
</div>
</div>
</div>
<p>The inference checkpoint <code class="docutils literal notranslate"><span class="pre">inference-last.ckpt</span></code> can be processed by an <a class="reference external" href="https://gitlab.dkrz.de/dwd-ki-zentrum/apps/aicon-anemoi">AICON-specific standalone tool</a> to produce ML-driven forecasts, see below. This implies that all necessary information is contained as meta-data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span><span class="o">,</span><span class="w"> </span><span class="nn">json</span>

<span class="n">inference_ckpt_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">hardware</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">checkpoints</span><span class="si">}{</span><span class="n">trainer</span><span class="o">.</span><span class="n">run_id</span><span class="si">}</span><span class="s2">/inference-last.ckpt&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkpoint file: </span><span class="si">{</span><span class="n">inference_ckpt_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># extract meta-data from checkpoint:</span>
<span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">inference_ckpt_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json_file</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
        <span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ai-models.json&quot;</span><span class="p">),</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">json_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;Inference checkpoint meta-data:</span>
<span class="s2">      </span>
<span class="s2">variables = </span><span class="si">{</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">number_of_grid_points = </span><span class="si">{</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span>
<span class="s2">refinement = </span><span class="si">{</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;graph&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">][</span><span class="s1">&#39;icon_mesh&#39;</span><span class="p">][</span><span class="s1">&#39;node_builder&#39;</span><span class="p">][</span><span class="s1">&#39;max_level_multimesh&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">model_timestep = </span><span class="si">{</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;timestep&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Checkpoint file: output_training/checkpoint/0210d057-147f-4d04-8d3f-df4b50044024/inference-last.ckpt
Inference checkpoint meta-data:

variables = [&#39;P_101&#39;, &#39;P_108&#39;, &#39;P_112&#39;, &#39;P_119&#39;, &#39;P_120&#39;, &#39;P_49&#39;, &#39;P_57&#39;, &#39;P_64&#39;, &#39;P_70&#39;, &#39;P_75&#39;, &#39;P_79&#39;, &#39;P_86&#39;, &#39;P_91&#39;, &#39;P_96&#39;, &#39;QV_101&#39;, &#39;QV_108&#39;, &#39;QV_112&#39;, &#39;QV_119&#39;, &#39;QV_120&#39;, &#39;QV_49&#39;, &#39;QV_57&#39;, &#39;QV_64&#39;, &#39;QV_70&#39;, &#39;QV_75&#39;, &#39;QV_79&#39;, &#39;QV_86&#39;, &#39;QV_91&#39;, &#39;QV_96&#39;, &#39;T_101&#39;, &#39;T_108&#39;, &#39;T_112&#39;, &#39;T_119&#39;, &#39;T_120&#39;, &#39;T_49&#39;, &#39;T_57&#39;, &#39;T_64&#39;, &#39;T_70&#39;, &#39;T_75&#39;, &#39;T_79&#39;, &#39;T_86&#39;, &#39;T_91&#39;, &#39;T_96&#39;, &#39;U_101&#39;, &#39;U_108&#39;, &#39;U_112&#39;, &#39;U_119&#39;, &#39;U_120&#39;, &#39;U_49&#39;, &#39;U_57&#39;, &#39;U_64&#39;, &#39;U_70&#39;, &#39;U_75&#39;, &#39;U_79&#39;, &#39;U_86&#39;, &#39;U_91&#39;, &#39;U_96&#39;, &#39;V_101&#39;, &#39;V_108&#39;, &#39;V_112&#39;, &#39;V_119&#39;, &#39;V_120&#39;, &#39;V_49&#39;, &#39;V_57&#39;, &#39;V_64&#39;, &#39;V_70&#39;, &#39;V_75&#39;, &#39;V_79&#39;, &#39;V_86&#39;, &#39;V_91&#39;, &#39;V_96&#39;, &#39;W_101&#39;, &#39;W_108&#39;, &#39;W_112&#39;, &#39;W_119&#39;, &#39;W_120&#39;, &#39;W_49&#39;, &#39;W_57&#39;, &#39;W_64&#39;, &#39;W_70&#39;, &#39;W_75&#39;, &#39;W_79&#39;, &#39;W_86&#39;, &#39;W_91&#39;, &#39;W_96&#39;, &#39;EMIS_RAD&#39;, &#39;FR_LAKE&#39;, &#39;FR_LAND&#39;, &#39;HSURF&#39;, &#39;SSO_GAMMA&#39;, &#39;SSO_SIGMA&#39;, &#39;SSO_STDH&#39;, &#39;SSO_THETA&#39;, &#39;Z0&#39;, &#39;cos_julian_day&#39;, &#39;cos_latitude&#39;, &#39;cos_local_time&#39;, &#39;cos_longitude&#39;, &#39;insolation&#39;, &#39;sin_julian_day&#39;, &#39;sin_latitude&#39;, &#39;sin_local_time&#39;, &#39;sin_longitude&#39;, &#39;ALB_RAD&#39;, &#39;CAPE_ML&#39;, &#39;CLCH&#39;, &#39;CLCL&#39;, &#39;CLCM&#39;, &#39;CLCT&#39;, &#39;FR_ICE&#39;, &#39;H_SNOW&#39;, &#39;PMSL&#39;, &#39;PS&#39;, &#39;QV_S&#39;, &#39;RAIN_CON&#39;, &#39;RELHUM_2M&#39;, &#39;SMI_0&#39;, &#39;SMI_1&#39;, &#39;TD_2M&#39;, &#39;TOT_PREC&#39;, &#39;T_2M&#39;, &#39;T_G&#39;, &#39;U_10M&#39;, &#39;V_10M&#39;]
number_of_grid_points = 11520
refinement = 3
model_timestep = 6h
</pre></div>
</div>
</div>
</div>
<p>Note, however, that Anemoi’s method to store the checkpoints is to save only the model’s <code class="docutils literal notranslate"><span class="pre">state_dict</span></code>, which contains just the learned parameters. Therefore, the model structure, including class definitions and functions, still needs to be available. This dependency is met by encapsulating the Python virtual environment in a container image.</p>
</section>
</section>
<section id="hidden-mesh-multi-mesh-definition">
<h2>Hidden mesh / multi-mesh definition<a class="headerlink" href="#hidden-mesh-multi-mesh-definition" title="Link to this heading">#</a></h2>
<p>The main feature of the AICON model (apart from its training dataset) is its graph construction directly based on ICON’s triangular meshes.</p>
<p>To understand the AICON hidden mesh definition it is first useful to have a look at the NetCDF grid file itself. This is a copy of the “classical” ICON grid [Prill2024], augmented by two additional fields, <code class="docutils literal notranslate"><span class="pre">refinement_level_v</span></code>, <code class="docutils literal notranslate"><span class="pre">refinement_level_c</span></code>. These are created during ICON’s hierarchical grid construction process.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_filename</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">icon_mesh</span><span class="o">.</span><span class="n">node_builder</span><span class="o">.</span><span class="n">grid_filename</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">grid_filename</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">netCDF4</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>
<span class="n">netcdf_grid</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">grid_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;number_of_grid_used: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">netcdf_grid</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;number_of_grid_used&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">netcdf_grid</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">var_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;refinement&quot;</span><span class="p">):</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">netcdf_grid</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name: </span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">, Dimensions: </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="si">}</span><span class="s2">, Datatype: </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">, Size: </span><span class="si">{</span><span class="n">sizes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
<span class="n">vlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">netcdf_grid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;vlat&quot;</span><span class="p">][:])</span>
<span class="n">vlon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">netcdf_grid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;vlon&quot;</span><span class="p">][:])</span>
<span class="n">reflvl_v</span> <span class="o">=</span> <span class="n">netcdf_grid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;refinement_level_v&quot;</span><span class="p">][:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>grid_filename=&#39;/shared/data/fe1ai/ml-datasets/structure/01_aicon-graph-files/icon_grid_0026_R03B07_G.nc&#39;
number_of_grid_used: 26
Name: refinement_level_v, Dimensions: (&#39;vertex&#39;,), Datatype: int32, Size: [1474562]
Name: refinement_level_c, Dimensions: (&#39;cell&#39;,), Datatype: int32, Size: [2949120]
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">refinement_level_v</span></code> index can be used to define evenly distributed sets of varying density.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Orthographic</span><span class="p">(</span><span class="n">central_longitude</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">central_latitude</span><span class="o">=</span><span class="mi">0</span><span class="p">)})</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">reflvl_v</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vlon</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">vlat</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="s1">&#39;ko&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/48a3b1908799c2debe92f749f1461fbfd9d4024075503574b4940fd186d6abf1.png" src="_images/48a3b1908799c2debe92f749f1461fbfd9d4024075503574b4940fd186d6abf1.png" />
</div>
</div>
<p>Each refinement level corresponds to a graph consisting of these points.</p>
<p>The <strong>hidden mesh</strong> of the AICON/Anemoi processor will be constructed as the union of these subgraphs. It therefore mixes long-range and short-range edges similar to the GraphCast multi-mesh (see the publication “GraphCast: Learning skillful medium-range global weather forecasting”, [Lam2022]).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_level_multimesh</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">icon_mesh</span><span class="o">.</span><span class="n">node_builder</span><span class="o">.</span><span class="n">max_level_multimesh</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">max_level_multimesh</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;number of hidden mesh nodes: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">reflvl_v</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">max_level_multimesh</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>max_level_multimesh=3
number of hidden mesh nodes: np.sum(reflvl_v &lt;= max_level_multimesh)=5762
</pre></div>
</div>
</div>
</div>
<p>The number of hidden mesh nodes therefore corresponds to the number of vertices in an <em>RnBk</em> ICON grid, where <em>n</em> denotes the ICON grid root index and k := <code class="docutils literal notranslate"><span class="pre">max_level_multimesh</span></code>. We can calculate its number of vertices as follows (see, eg., [Prill2024] for the formula):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">netcdf_grid</span><span class="p">,</span> <span class="s1">&#39;grid_root&#39;</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">max_level_multimesh</span>

<span class="c1"># no. of vertices:</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="o">**</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="si">=}</span><span class="s2"> hidden mesh vertices&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10 * n**2 * 4**k + 2=5762 hidden mesh vertices
</pre></div>
</div>
</div>
</div>
<p>Finally, the set of edges in the hidden mesh is equivalent to the union of all edges in the coarse-to-fine level hierarchy <code class="docutils literal notranslate"><span class="pre">RnB0</span></code> … <code class="docutils literal notranslate"><span class="pre">RnBk</span></code>. We can verify this with the formula for icosahedral meshes, <span class="math notranslate nohighlight">\(n_e = 30 n^2 4^k\)</span>. Note that the hidden mesh is an undirected graph, which is modelled as a directed graph with exactly twice the number of edges.
This result is identical to the number of hidden mesh edges that was generated in our AICON example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">netcdf_grid</span><span class="p">,</span> <span class="s1">&#39;grid_root&#39;</span><span class="p">)</span>
<span class="n">nedges_total</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_level_multimesh</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
	<span class="c1"># no. of edges for level k:</span>
	<span class="n">nedges_total</span> <span class="o">+=</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">n</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span><span class="o">**</span><span class="n">k</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;calculated number of edges: </span><span class="si">{</span><span class="mi">2</span><span class="o">*</span><span class="n">nedges_total</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">edges</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">graph_data</span><span class="o">.</span><span class="n">edge_stores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;number of edges in the AICON multi-mesh: </span><span class="si">{</span><span class="n">edges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>calculated number of edges: 2*nedges_total=45900
number of edges in the AICON multi-mesh: 45900
</pre></div>
</div>
</div>
</div>
<p>For AICON there exist two classes in Anemoi that create the spatial graph nodes (discrete points) for the AICON model, <code class="docutils literal notranslate"><span class="pre">ICONCellGridNodes</span></code> and <code class="docutils literal notranslate"><span class="pre">ICONMultimeshNodes</span></code>. These are activated in the YAML setup as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>

<span class="c1"># find corresponding source code file:</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span><span class="o">,</span><span class="w"> </span><span class="nn">inspect</span>
<span class="n">classname_icon_node_builder</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">hidden</span><span class="o">.</span><span class="n">node_builder</span><span class="o">.</span><span class="n">_target_</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;anemoi.graphs.nodes&quot;</span><span class="p">)</span>
<span class="bp">cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;ICONMultimeshNodes&quot;</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Implementation: can be found in </span><span class="si">{</span><span class="n">path</span><span class="p">[</span><span class="n">path</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">):]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>icon_mesh:
  node_builder:
    _target_: anemoi.graphs.nodes.ICONNodes
    name: icon_grid_0026_R03B07_G
    grid_filename: /shared/data/fe1ai/ml-datasets/structure/01_aicon-graph-files/icon_grid_0026_R03B07_G.nc
    max_level_multimesh: 3
    max_level_dataset: 3
data:
  node_builder:
    _target_: anemoi.graphs.nodes.ICONCellGridNodes
    icon_mesh: icon_mesh
  attributes: ${graph.attributes.nodes}
hidden:
  node_builder:
    _target_: anemoi.graphs.nodes.ICONMultimeshNodes
    icon_mesh: icon_mesh

Implementation: can be found in src/anemoi/graphs/nodes/builders/from_icon.py.
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ICONCellGridNodes</span></code> object describes the ICON data mesh, ie. with the data locations at the cell circumcenters.
Here, we focus on the hidden mesh object <code class="docutils literal notranslate"><span class="pre">anemoi.graphs.nodes.ICONMultimeshNodes</span></code> which can be visualized as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">LineCollection</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Extract coordinates and edges</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">graph_data</span><span class="o">.</span><span class="n">node_stores</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="n">edges</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">graph_data</span><span class="o">.</span><span class="n">edge_stores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># Create segments as a NumPy array</span>
<span class="n">segments</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">edges</span><span class="p">]</span>

<span class="c1"># Set up Cartopy map</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Orthographic</span><span class="p">(</span><span class="n">central_longitude</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">central_latitude</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>

<span class="c1"># Plot nodes and edges</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">lc</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d0ce743ef34c2d38034c93824d5c877f14f51d9151888871a81693764f8e9494.png" src="_images/d0ce743ef34c2d38034c93824d5c877f14f51d9151888871a81693764f8e9494.png" />
</div>
</div>
<p>We generate this plot a second time. This time we generate edge-vertex relations level-wise in order to make the coarser levels more visible:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">HeteroData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">anemoi.graphs.create</span><span class="w"> </span><span class="kn">import</span> <span class="n">GraphCreator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">anemoi.training.schemas.base_schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">convert_to_omegaconf</span>

<span class="n">graph_config</span> <span class="o">=</span> <span class="n">convert_to_omegaconf</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">graph</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">HeteroData</span><span class="p">()</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">GraphCreator</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">graph_config</span><span class="p">)</span><span class="o">.</span><span class="n">update_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

<span class="n">edge_vertices_fine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">netcdf_grid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;edge_vertices&quot;</span><span class="p">][:]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">cell_vertices_fine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">netcdf_grid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;vertex_of_cell&quot;</span><span class="p">][:]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

<span class="n">multi_mesh</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;icon_mesh&quot;</span><span class="p">][</span><span class="s2">&quot;_multi_mesh&quot;</span><span class="p">]</span>
<span class="p">(</span><span class="n">edge_vertices</span><span class="p">,</span> <span class="n">cell_vertices</span><span class="p">)</span> <span class="o">=</span> <span class="n">multi_mesh</span><span class="o">.</span><span class="n">_get_hierarchy_of_icon_edge_graphs</span><span class="p">(</span>
            <span class="n">edge_vertices_fine</span><span class="o">=</span><span class="n">edge_vertices_fine</span><span class="p">,</span>
            <span class="n">cell_vertices_fine</span><span class="o">=</span><span class="n">cell_vertices_fine</span><span class="p">,</span>
            <span class="n">reflvl_vertex</span><span class="o">=</span><span class="n">reflvl_v</span><span class="p">,</span>
        <span class="p">)</span>

<span class="n">coords_fine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">vlon</span><span class="p">,</span> <span class="n">vlat</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">LineCollection</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.feature</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfeature</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Orthographic</span><span class="p">(</span><span class="n">central_longitude</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">central_latitude</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>  <span class="c1"># Make aspect quadratic (square)</span>

<span class="c1"># Fill land with light gray</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">)</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">]</span>

<span class="c1"># Increase line widths to make lines thicker, smaller target_lvl index thicker</span>
<span class="n">line_widths</span> <span class="o">=</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]</span>

<span class="k">for</span> <span class="n">tgt_level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">edge_vertices</span><span class="p">[</span><span class="n">tgt_level</span><span class="p">]</span>
    <span class="n">segments</span> <span class="o">=</span> <span class="n">coords_fine</span><span class="p">[</span><span class="n">edges</span><span class="p">]</span>

    <span class="n">lc</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span>
        <span class="n">segments</span><span class="p">,</span>
        <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">tgt_level</span><span class="p">],</span>
        <span class="n">linewidths</span><span class="o">=</span><span class="n">line_widths</span><span class="p">[</span><span class="n">tgt_level</span><span class="p">],</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>

<span class="c1"># Remove plot frame (all spines)</span>
<span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;output_plot.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8a5776d07fd0051a02e1de08d56160ab92ededc50ca4f2882b3e1ed054e1d61f.png" src="_images/8a5776d07fd0051a02e1de08d56160ab92ededc50ca4f2882b3e1ed054e1d61f.png" />
</div>
</div>
<p>This is the graph on which the Graph Neural Network (GNN) operates.</p>
</section>
<section id="model-architecture">
<h2>Model architecture<a class="headerlink" href="#model-architecture" title="Link to this heading">#</a></h2>
<p>We now turn our focus on the machine learning model itself.</p>
<p>Deterministic weather forecasting can be formulated as</p>
<div class="math notranslate nohighlight">
\[
\bigl[ X_{t-(\alpha-1)}, \ldots, X_t \bigr] \overset{\mathcal{F}(\theta)}{\rightarrow} \bigl[ Y_{t+1}, \ldots, Y_{t+\beta} \bigr]
\]</div>
<p>where <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span> are sets of input and output variables; <span class="math notranslate nohighlight">\(\alpha\)</span> and <span class="math notranslate nohighlight">\(\beta\)</span> are the temporal lengths of the input and output windows and <span class="math notranslate nohighlight">\(\mathcal{F}(\theta)\)</span> represents the model with the learnable parameters <span class="math notranslate nohighlight">\(\theta\)</span>.</p>
<ul class="simple">
<li><p>For AICON, we have <span class="math notranslate nohighlight">\(\alpha := 2\)</span>, <span class="math notranslate nohighlight">\(\beta=1\)</span>, ie. the model receives as input a representation of the atmospheric states at <span class="math notranslate nohighlight">\(t_{-3h}\)</span>, <span class="math notranslate nohighlight">\(t_0\)</span> and then forecasts the state at time <span class="math notranslate nohighlight">\(t_{+3h}\)</span>.</p></li>
<li><p>Forecasts for longer lead-times are calculated by initializing the model from its own prediction (so-called <strong>rollout</strong>).</p></li>
</ul>
<p>Additional remark: AICON’s/Anemoi’s encoder-processor-decoder model uses so-called <strong>skip connections</strong> (also known as ‘residual connections’). These are links that bypass the model layers by adding the input directly to the output, meaning that the network focuses on learning changes. Skip connections allow the model to preserve original node information by adding it back in at a later stage.</p>
<section id="encoder-decoder-model">
<h3>Encoder-decoder model<a class="headerlink" href="#encoder-decoder-model" title="Link to this heading">#</a></h3>
<p>The example model run at the beginning of this notebook was based on an AICON configuration which operated on a small test dataset.
We now investigate this AICON configuration in more detail.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">omegaconf</span><span class="w"> </span><span class="kn">import</span> <span class="n">OmegaConf</span>

<span class="c1"># Print the &#39;model&#39; section</span>
<span class="nb">print</span><span class="p">(</span><span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>output_mask:
  _target_: anemoi.training.utils.masks.NoOutputMask
cpu_offload: false
model:
  _target_: anemoi.models.models.encoder_processor_decoder.AnemoiModelEncProcDec
keep_batch_sharded: true
num_channels: 64
processor:
  _target_: anemoi.models.layers.processor.GraphTransformerProcessor
  _convert_: all
  trainable_size: ${model.trainable_parameters.hidden2hidden}
  sub_graph_edge_attributes: ${model.attributes.edges}
  num_layers: 2
  num_chunks: 1
  cpu_offload: ${model.cpu_offload}
  mlp_hidden_ratio: 4
  num_heads: 16
  qk_norm: false
  layer_kernels:
    Linear:
      _target_: torch.nn.Linear
      _partial_: true
    Activation:
      _target_: torch.nn.GELU
encoder:
  _target_: anemoi.models.layers.mapper.GraphTransformerForwardMapper
  _convert_: all
  trainable_size: ${model.trainable_parameters.data2hidden}
  sub_graph_edge_attributes: ${model.attributes.edges}
  num_chunks: 2
  cpu_offload: ${model.cpu_offload}
  mlp_hidden_ratio: 4
  num_heads: 16
  qk_norm: false
  layer_kernels:
    Linear:
      _target_: torch.nn.Linear
      _partial_: true
    Activation:
      _target_: torch.nn.GELU
decoder:
  _target_: anemoi.models.layers.mapper.GraphTransformerBackwardMapper
  _convert_: all
  trainable_size: ${model.trainable_parameters.hidden2data}
  sub_graph_edge_attributes: ${model.attributes.edges}
  num_chunks: 1
  cpu_offload: ${model.cpu_offload}
  mlp_hidden_ratio: 4
  num_heads: 16
  qk_norm: false
  initialise_data_extractor_zero: false
  layer_kernels:
    Linear:
      _target_: torch.nn.Linear
      _partial_: true
    Activation:
      _target_: torch.nn.GELU
trainable_parameters:
  data: 8
  hidden: 8
  data2hidden: 0
  hidden2data: 0
  hidden2hidden: 0
attributes:
  edges:
  - edge_length
  - edge_dirs
  nodes: []
bounding:
- _target_: anemoi.models.layers.bounding.ReluBounding
  variables: []
</pre></div>
</div>
</div>
</div>
<p>The output shows that our example setup describes a GraphTransformer neural network architecture, which is one of Anemoi’s two GNN architectures. Below we will shortly discuss both variants: the <strong>GraphTransformer</strong> and the <strong>MessagePassing</strong> GNN.</p>
<p>Technically, AICON applies a standard <code class="docutils literal notranslate"><span class="pre">trainer.model</span></code> to the graph structures from the previous section. The <code class="docutils literal notranslate"><span class="pre">trainer.model</span></code> is a object-oriented composition, where the members are</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GraphForecaster</span></code>: a PyTorch Lightning module responsible for the model’s forward pass.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AnemoiModelInterface</span></code>: standardizes how the training system interacts with the model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AnemoiEncProcDec</span></code>: refers to the Encoder-Processor-Decoder architecture.</p></li>
</ul>
<p>In computer science, a <em>composition</em> denotes a relationship where one object contains other objects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jupyter_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_class_name</span><span class="p">,</span> <span class="n">get_parent_class_name</span>
<span class="n">graph</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;graph LR</span>
<span class="si">{</span><span class="n">get_class_name</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="si">}</span><span class="s2">--&gt; </span><span class="si">{</span><span class="n">get_parent_class_name</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="si">}</span>

<span class="s2">subgraph </span><span class="si">{</span><span class="n">get_class_name</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="si">}</span>
<span class="s2">  subgraph </span><span class="si">{</span><span class="n">get_class_name</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="si">}</span>
<span class="s2">    subgraph </span><span class="si">{</span><span class="n">get_class_name</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="si">}</span>
<span class="s2">    end</span>
<span class="s2">  end      </span>
<span class="s2">end</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="o">%</span><span class="k">mermaid_magic</span> --src graph
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><iframe srcdoc="&lt;html&gt;
    &lt;body&gt;
        &lt;script src=&quot;https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js&quot;&gt;&lt;/script&gt;
        &lt;script&gt;
            mermaid.initialize({ startOnLoad: true });
        &lt;/script&gt;
 
        &lt;div class=&quot;mermaid&quot;&gt;
            graph LR
anemoi.training.train.tasks.forecaster.GraphForecaster--&gt; anemoi.training.train.tasks.base.BaseGraphModule

subgraph anemoi.training.train.tasks.forecaster.GraphForecaster
  subgraph anemoi.models.interface.AnemoiModelInterface
    subgraph anemoi.models.models.encoder_processor_decoder.AnemoiModelEncProcDec
    end
  end      
end
        &lt;/div&gt;
 
    &lt;/body&gt;
&lt;/html&gt;
" width="100%" height="300"style="border:none !important;" "allowfullscreen" "webkitallowfullscreen" "mozallowfullscreen"></iframe></div></div>
</div>
<p>Let us retrieve once again a summary of the number of model parameters. To this end we provide an example input array with the required shape:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbatch</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
         <span class="n">ndates</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span> 
         <span class="n">nensembles</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
         <span class="n">npoints</span> <span class="o">:=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">datamodule</span><span class="o">.</span><span class="n">ds_train</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">field_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
         <span class="n">nvariables</span> <span class="o">:=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">num_input_channels</span><span class="p">)</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">example_input_array</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pytorch_lightning.utilities.model_summary</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelSummary</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">ModelSummary</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  | Name    | Type                 | Params | Mode  | FLOPs | In sizes                          | Out sizes         
--------------------------------------------------------------------------------------------------------------------------
0 | model   | AnemoiModelInterface | 443 K  | train | 4.1 B | [[1, 2, 1, 11520, 123], &#39;?&#39;, &#39;?&#39;] | [1, 1, 11520, 105]
1 | loss    | WeightedMSELoss      | 0      | train | 0     | ?                                 | ?                 
2 | metrics | ModuleDict           | 0      | train | 0     | ?                                 | ?                 
--------------------------------------------------------------------------------------------------------------------------
443 K     Trainable params
0         Non-trainable params
443 K     Total params
1.773     Total estimated model params size (MB)
102       Modules in train mode
0         Modules in eval mode
4.1 B     Total Flops
</pre></div>
</div>
</div>
</div>
<p>At a closer look, the model parameters are distributed over the three main building blocks of the model:</p>
<ul class="simple">
<li><p><strong>Encoder:</strong> Transforms raw node and edge features into latent representations suitable for graph processing. A feature in weather forecasting GNNs is a variable at a specific location and time, such as temperature, wind speed, or atmospheric pressure.</p></li>
<li><p><strong>Processor:</strong> Iteratively updates node embeddings by aggregating and exchanging information across the graph structure using message passing.</p></li>
<li><p><strong>Decoder:</strong> Maps the final node or graph embeddings to the desired output.</p></li>
</ul>
<p>We can count these parameters as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">encoder</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span>
<span class="n">processor</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">processor</span>
<span class="n">decoder</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">decoder</span>

<span class="n">nEnc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
<span class="n">nPrc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processor</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
<span class="n">nDec</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">decoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Encoder:   number of trainable parameters = </span><span class="si">{</span><span class="n">nEnc</span><span class="si">}</span>
<span class="s2">Processor: number of trainable parameters = </span><span class="si">{</span><span class="n">nPrc</span><span class="si">}</span>
<span class="s2">Decoder:   number of trainable parameters = </span><span class="si">{</span><span class="n">nDec</span><span class="si">}</span>

<span class="s2">sum: </span><span class="si">{</span><span class="n">nEnc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nPrc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nDec</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Encoder:   number of trainable parameters = 71936
Processor: number of trainable parameters = 108800
Decoder:   number of trainable parameters = 78057

sum: 258793
</pre></div>
</div>
</div>
</div>
<p>We observe that there is a discrepancy between the total number of parameters reported above (<code class="docutils literal notranslate"><span class="pre">ModelSummary:</span> <span class="pre">Total</span> <span class="pre">params</span></code>) and the sum of encoder, processor and decoder parameters. This accounts to the so-called <strong>extra trainable parameters</strong>, defined in the YAML configuration:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">trainable_parameters</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data: 8
hidden: 8
data2hidden: 0
hidden2data: 0
hidden2hidden: 0
</pre></div>
</div>
</div>
</div>
<p>Adding extra trainable features can increase the model’s capacity to learn complex patterns or compensate for missing information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">additional_trainable</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">node_attributes</span>
<span class="n">nTrn</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">additional_trainable</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&quot;Trainable parameters&quot;:   number of extra trainable parameters = </span><span class="si">{</span><span class="n">nTrn</span><span class="si">}</span>

<span class="s2">total sum: </span><span class="si">{</span><span class="n">nEnc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nPrc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nDec</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nTrn</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;Trainable parameters&quot;:   number of extra trainable parameters = 184352

total sum: 443145
</pre></div>
</div>
</div>
</div>
<p>By the way, to make the feature vector (input tensor) a bit more concrete, we can visualize its contents by adding the variable names to its indices:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># collect variables and their indices in our input vector:</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data_indices</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s2">&quot;name_to_index&quot;</span><span class="p">]</span>
<span class="n">get_similar_key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">k</span>

<span class="n">var_indices</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">var_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">get_similar_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="nb">min</span><span class="p">(</span><span class="n">var_indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">get_similar_key</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> 
               <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
               
<span class="n">vec_len</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">num_input_channels</span>
<span class="n">sorted_vars</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">var_indices</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vec_len</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_vars</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">0.1</span>  <span class="c1"># even above, odd below</span>
    <span class="n">va</span> <span class="o">=</span> <span class="s2">&quot;bottom&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;top&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="n">va</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vec_len</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/165425d059a867233a1194e468b6ee5310b55e08f5ce4110bc7ba7ab7341f21a.png" src="_images/165425d059a867233a1194e468b6ee5310b55e08f5ce4110bc7ba7ab7341f21a.png" />
</div>
</div>
</section>
<section id="encoder-and-decoder-graph">
<h3>Encoder and decoder graph<a class="headerlink" href="#encoder-and-decoder-graph" title="Link to this heading">#</a></h3>
<p>This section discusses the AICON encoder and decoder. Short recap: The encoder and decoder transform raw node and edge features - ICON cell data - into latent representations, and vice versa.</p>
<p>More generally speaking, the Graph Neural Network encoder and decoder are based on a <strong>bipartite graph</strong>. In a bipartite graph, nodes are divided into two disjoint sets, and edges only connect nodes from different sets - not within the same set.</p>
<p>In PyTorch Geometric (PyG), the bipartite graph is defined by explicitly separating source and target node feature matrices and by using an edge index that connects nodes from the source set to nodes in the target set. For visualization, we transform the AICON/Anemoi bipartite encoder graph into a <code class="docutils literal notranslate"><span class="pre">NetworkX</span></code> graph data structure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">encoder</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>

<span class="n">edge_index</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">edge_index_base</span> <span class="c1"># [2, num_edges]</span>
<span class="n">num_data</span>   <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">num_hidden</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num_data</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">num_hidden</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_data</span><span class="p">),</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Source set</span>
<span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_data</span><span class="p">,</span> <span class="n">num_data</span> <span class="o">+</span> <span class="n">num_hidden</span><span class="p">),</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Target set</span>

<span class="n">edges</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">num_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edge_index</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span>
<span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>num_data=11520, num_hidden=5762
</pre></div>
</div>
</div>
</div>
<p>The <strong>encoder graph</strong> for AICON is defined by the ICON grid topology: Every data node is connected to the hidden mesh vertices that are given by the cell-to-vertex relationship. Therefore every data point is connected to exactly 3 hidden mesh nodes. Note that the <strong>decoder graph</strong> is defined as the transpose of this mapping.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;maximum degree of source nodes: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="w"> </span><span class="nb">dict</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_data</span><span class="p">)))</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>maximum degree of source nodes: 3
</pre></div>
</div>
</div>
</div>
<p>Be aware of the fact that the reverse statement is not true:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;overall maximum degree of encoder graph: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="w"> </span><span class="nb">dict</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">degree</span><span class="p">())</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>overall maximum degree of encoder graph: 6
</pre></div>
</div>
</div>
</div>
<p>Since every data point is connected to three vertices of the hidden mesh we can calculate the total number of encoder edges as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">netcdf_grid</span><span class="p">,</span> <span class="s1">&#39;grid_root&#39;</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">icon_mesh</span><span class="o">.</span><span class="n">node_builder</span><span class="o">.</span><span class="n">max_level_multimesh</span>

<span class="n">ncells</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">n</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span><span class="o">**</span><span class="n">k</span>
<span class="n">nedges</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">ncells</span> <span class="c1"># each cell is connected to 3 vertices</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nedges</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>nedges=34560
</pre></div>
</div>
</div>
</div>
<p>The following plot illustrates how multiple data points are mapped to the latent representation on the coarse hidden mesh. We restrict the graph to the first few edges for better visualization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nodes_subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">25</span><span class="p">]]</span>
<span class="c1"># add the edge neighbors of any of these nodes to node_subset:</span>
<span class="n">nodes_subset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nodes_subset</span><span class="p">)</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes_subset</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
    <span class="n">neighbors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
    <span class="n">nodes_subset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span> 
    
<span class="n">G_sub</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">nodes_subset</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># Get the two node sets (if not already known)</span>
<span class="n">nodes_top</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">G_sub</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;bipartite&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">nodes_bottom</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">G_sub</span><span class="p">)</span> <span class="o">-</span> <span class="n">nodes_top</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">bipartite_layout</span><span class="p">(</span><span class="n">G_sub</span><span class="p">,</span> <span class="n">nodes_top</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>

<span class="n">top</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">G_sub</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">nodes_top</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">bottom</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">G_sub</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">nodes_bottom</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span>
    <span class="n">G_sub</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;&lt;|-&#39;</span><span class="p">,</span> <span class="n">arrowsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="n">G_sub</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Hidden Mesh&#39;</span><span class="p">,</span> <span class="s1">&#39;Data Mesh&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b01df8f23f1b0e06feb993299244428d6ef2845d43b6e2a816bcc7054fe330bf.png" src="_images/b01df8f23f1b0e06feb993299244428d6ef2845d43b6e2a816bcc7054fe330bf.png" />
</div>
</div>
<p>In the above illustration we have selected a subset of the bipartite encoder graph <code class="docutils literal notranslate"><span class="pre">encoder.edge_index</span></code> in order to simplify the illustration, the so-called <strong>1-hop induced subgraph</strong>. It is worth noting that the Anemoi MessagePassing GNN uses a similar method to parallelize a model over multiple GPUs: This procedure is called <strong>edge sharding</strong> and calls the function <a class="reference external" href="https://pytorch-geometric.readthedocs.io/en/2.4.0/_modules/torch_geometric/utils/subgraph.html"><code class="docutils literal notranslate"><span class="pre">bipartite_subgraph</span></code></a> from the <code class="docutils literal notranslate"><span class="pre">torch_geometric</span></code> package. Every GPU then operates on this subset of encoder edges only.</p>
<p>For our example configuration, however, we have chosen a non-parallel (single-GPU) training. This is indicated by the YAML file setting:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span><span class="o">.</span><span class="n">hardware</span><span class="o">.</span><span class="n">num_gpus_per_model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
</section>
<section id="gnn-processor">
<h3>GNN Processor<a class="headerlink" href="#gnn-processor" title="Link to this heading">#</a></h3>
<p>We will now describe the GNN processor from AICON. The processor in encoder-processor-decoder networks iteratively refines encoded features before decoding.</p>
<p>In AICON, the processor is an unmodified component of the <code class="docutils literal notranslate"><span class="pre">anemoi-models</span></code> package.
Many details of its <code class="docutils literal notranslate"><span class="pre">torch_geometric</span></code> implementation also apply to the encoder and decoder module, which is why we kept the description rather short.</p>
<p>As explained above, the processor operates on a hidden or multi-mesh graph consisting of long-range and short-range edges. We visualize a small part of this graph by plotting the neighbors and neighbors’ neighbors of the North Pole.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_node</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># arbitrary node index; here: pole</span>

<span class="c1"># ----------------------------------------------</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="n">edges</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">graph_data</span><span class="o">.</span><span class="n">edge_stores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">edge_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">edge_list</span><span class="p">)</span>

<span class="n">first_neighbors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">target_node</span><span class="p">))</span>
<span class="n">second_neighbors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">first_neighbors</span><span class="p">:</span>
    <span class="n">second_neighbors</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<span class="n">nodes_to_plot</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">target_node</span><span class="p">])</span> <span class="o">|</span> <span class="n">first_neighbors</span> <span class="o">|</span> <span class="n">second_neighbors</span>

<span class="n">subgraph</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">nodes_to_plot</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spectral_layout</span><span class="p">(</span><span class="n">subgraph</span><span class="p">)</span>

<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">subgraph</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">subgraph</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="p">[</span><span class="n">target_node</span><span class="p">],</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>  <span class="c1"># highlight target node</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/887a42c202b626141051e0fe46d335204327794611f45b9e362995859a1e7809.png" src="_images/887a42c202b626141051e0fe46d335204327794611f45b9e362995859a1e7809.png" />
</div>
</div>
<p>First, we investigate the class hierarchy of the Encoder-Processor-Decoder object that was explained in the overview.
The processor is actually a composition of objects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ModelEncProcDec</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encoder-Processor-Decoder object: </span><span class="si">{</span><span class="n">get_class_name</span><span class="p">(</span><span class="n">ModelEncProcDec</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">objects</span> <span class="o">=</span> <span class="p">[</span>
<span class="s2">&quot;ModelEncProcDec&quot;</span><span class="p">,</span>
<span class="s2">&quot;ModelEncProcDec.processor&quot;</span><span class="p">,</span>
<span class="s2">&quot;ModelEncProcDec.processor.proc[0]&quot;</span><span class="p">,</span>
<span class="s2">&quot;ModelEncProcDec.processor.proc[0].blocks[0]&quot;</span><span class="p">,</span>
<span class="s2">&quot;ModelEncProcDec.processor.proc[0].blocks[0].conv&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Encoder-Processor-Decoder object: anemoi.models.models.encoder_processor_decoder.AnemoiModelEncProcDec
</pre></div>
</div>
</div>
</div>
<p>The following lists the data types which correspond to this composition of objects:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Object&#39;</span><span class="p">:</span> <span class="n">objects</span><span class="p">,</span>
    <span class="s1">&#39;Class (in this example)&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="n">get_class_name</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">],</span>
<span class="p">}</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
<span class="n">display</span><span class="p">(</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">pandas_table_style</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_4831c th {
  text-align: left;
  font-size: 12pt;
}
#T_4831c td {
  text-align: left;
  font-size: 12pt;
}
</style>
<table id="T_4831c">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_4831c_level0_col0" class="col_heading level0 col0" >Object</th>
      <th id="T_4831c_level0_col1" class="col_heading level0 col1" >Class (in this example)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_4831c_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_4831c_row0_col0" class="data row0 col0" >ModelEncProcDec</td>
      <td id="T_4831c_row0_col1" class="data row0 col1" >anemoi.models.models.encoder_processor_decoder.AnemoiModelEncProcDec</td>
    </tr>
    <tr>
      <th id="T_4831c_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_4831c_row1_col0" class="data row1 col0" >ModelEncProcDec.processor</td>
      <td id="T_4831c_row1_col1" class="data row1 col1" >anemoi.models.layers.processor.GraphTransformerProcessor</td>
    </tr>
    <tr>
      <th id="T_4831c_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_4831c_row2_col0" class="data row2 col0" >ModelEncProcDec.processor.proc[0]</td>
      <td id="T_4831c_row2_col1" class="data row2 col1" >anemoi.models.layers.chunk.GraphTransformerProcessorChunk</td>
    </tr>
    <tr>
      <th id="T_4831c_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_4831c_row3_col0" class="data row3 col0" >ModelEncProcDec.processor.proc[0].blocks[0]</td>
      <td id="T_4831c_row3_col1" class="data row3 col1" >anemoi.models.layers.block.GraphTransformerProcessorBlock</td>
    </tr>
    <tr>
      <th id="T_4831c_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_4831c_row4_col0" class="data row4 col0" >ModelEncProcDec.processor.proc[0].blocks[0].conv</td>
      <td id="T_4831c_row4_col1" class="data row4 col1" >anemoi.models.layers.conv.GraphTransformerConv</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We now concentrate on the innermost block of the processor.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">GraphTransformerConv</span></code> (Graph Attention Network) or the more basic <code class="docutils literal notranslate"><span class="pre">GraphConv</span></code> (Message Passing Neural Network) constitute the interface to the <code class="docutils literal notranslate"><span class="pre">torch_geometric</span></code> package.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shortlist</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_updater&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_update&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;aggregate&#39;</span><span class="p">,</span> <span class="s1">&#39;message_and_aggregate&#39;</span><span class="p">,</span> <span class="s1">&#39;propagate&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;explain_message&#39;</span><span class="p">}</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jupyter_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">class_to_graphviz</span>
<span class="n">class_to_graphviz</span><span class="p">(</span><span class="n">anemoi</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">GraphConv</span><span class="p">,</span> <span class="n">shortlist</span><span class="o">=</span><span class="n">shortlist</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/032b0dba604ee56ee5255ed51997c31c97728b8fe911cd7175fdbf6bd16afba7.svg" src="_images/032b0dba604ee56ee5255ed51997c31c97728b8fe911cd7175fdbf6bd16afba7.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">class_to_graphviz</span><span class="p">(</span><span class="n">anemoi</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">GraphTransformerConv</span><span class="p">,</span> <span class="n">shortlist</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4f96a167a36ca2e719f77d138650058bbd5ffeb7484493dd371b99ab161817e9.svg" src="_images/4f96a167a36ca2e719f77d138650058bbd5ffeb7484493dd371b99ab161817e9.svg" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">propagate()</span></code> function in PyTorch Geometric is the core message-passing mechanism for GNNs, handling neighbor aggregation and node updates.
Sparse matrix operations in its implementation avoid explicit loops over individual nodes/edges.</p>
<p>The mathematical expression for the <code class="docutils literal notranslate"><span class="pre">propagate()</span></code> function of the <strong>MessagePassing GNN</strong> is as follows:</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
 x_i' = \gamma_{\Theta} \bigl(x_i, \bigoplus_{j \in \mathcal{N}(i)} \phi_{\Theta}(x_i,x_j,e_{j,i}) \bigr)
\end{align*}
\]</div>
<p>where</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(i\)</span>: refers to a <em>target node</em>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathcal{N}(i)\)</span>: neighborhood of node <span class="math notranslate nohighlight">\(i\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(x_i\)</span>: node features</p></li>
<li><p><span class="math notranslate nohighlight">\(e_{j,i}\)</span>: edge features</p></li>
<li><p><span class="math notranslate nohighlight">\(\oplus\)</span>: aggregation scheme: sum, mean, or max operation</p></li>
<li><p><span class="math notranslate nohighlight">\(\gamma\)</span>: <code class="docutils literal notranslate"><span class="pre">update()</span></code> function</p></li>
<li><p><span class="math notranslate nohighlight">\(\phi\)</span>: <code class="docutils literal notranslate"><span class="pre">message()</span></code> function</p></li>
<li><p><span class="math notranslate nohighlight">\(\theta\)</span> refers to the set of learnable parameters (weights)</p></li>
</ul>
<p>An alternative formulation for “message” aggregation mechanism is that each node’s new features become a weighted average of its neighbors’ features. Mathematically this is equivalent to multiplying node features by the normalized adjacency matrix.</p>
<p>In contrast to this, the mathematical formulation for the <code class="docutils literal notranslate"><span class="pre">propagate()</span></code> function of the <strong>GraphTransformer GNN</strong> [Shi2021] is as follows:</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
 x_i' = W_1 x_i + \sum_{j \in \mathcal{N}(i)} \alpha_{i,j} W_2 x_j
\end{align*}
\]</div>
<p>where</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\alpha_{i,j}\)</span>: attention coefficients</p></li>
<li><p><span class="math notranslate nohighlight">\(W_k\)</span>: learnable parameters (weights)</p></li>
</ul>
<p>This means that a multi-head attention matrix <span class="math notranslate nohighlight">\( \alpha_{i,j}\)</span> replaces the original normalized adjacency matrix as transition matrix for message passing.</p>
<p>The self attention matrix <span class="math notranslate nohighlight">\(\alpha\)</span> is defined as</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
 \alpha_{i,j} = \textrm{softmax} \Bigl[ \frac{K_j^T Q_i}{\sqrt{d}} \Bigr]
\end{align*}
\]</div>
<p>where</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(d\)</span>: number of channels.</p></li>
<li><p><span class="math notranslate nohighlight">\(Q\)</span>,  <span class="math notranslate nohighlight">\(K\)</span>: queries, keys of the attention mechanism</p></li>
<li><p>the <span class="math notranslate nohighlight">\(\textrm{softmax}\)</span> function is a smooth and differentiable transformation function, commonly used in ML architectures.</p></li>
</ul>
<p><img alt="Graph Transformer details" src="_images/graph_transformer_details.png" /></p>
<p>For multi-head attention, the outputs of multiple self-attention mechanisms are vertically concatenated. The dimension must be divisible by number of heads.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">num_heads</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cfg.model.encoder.num_heads=16
</pre></div>
</div>
</div>
</div>
</section>
<section id="attention-graph">
<h3>Attention Graph<a class="headerlink" href="#attention-graph" title="Link to this heading">#</a></h3>
<p>We now take a closer look at the attention matrix of the  GraphTransformer GNN. Can we visualize the attention that the target node <code class="docutils literal notranslate"><span class="pre">i</span></code> pays to the input <code class="docutils literal notranslate"><span class="pre">j</span></code>?</p>
<p>To this end, we apply a trick and wrap the <code class="docutils literal notranslate"><span class="pre">message()</span></code> function to capture the attention matrix (this programming technique is called <em>Monkeypatching</em>). The corresponding code for the attention matrix has been taken from the original implementation <a class="reference external" href="https://github.com/ecmwf/anemoi-models/blob/develop/src/anemoi/models/layers/conv.py"><code class="docutils literal notranslate"><span class="pre">src/anemoi/models/layers/conv.py</span></code></a>. Arguments with the <code class="docutils literal notranslate"><span class="pre">_j</span></code> and <code class="docutils literal notranslate"><span class="pre">_i</span></code> suffixes correspond to the source and target node for each edge, respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">types</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">softmax</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">proc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">conv</span>
<span class="n">original_message_function</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">message</span>

<span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">original_message_function</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">message_with_attention_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">query_i</span><span class="p">,</span> <span class="n">key_j</span><span class="p">,</span> <span class="n">value_j</span><span class="p">,</span> <span class="n">edge_attr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_i</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">alpha</span>
    <span class="k">if</span> <span class="n">edge_attr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key_j</span> <span class="o">=</span> <span class="n">key_j</span> <span class="o">+</span> <span class="n">edge_attr</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">query_i</span> <span class="o">*</span> <span class="n">key_j</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="c1"># the index argument provides, for each edge, the index of the node that will receive the message</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">original_message_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">query_i</span><span class="p">,</span> <span class="n">key_j</span><span class="p">,</span> <span class="n">value_j</span><span class="p">,</span> <span class="n">edge_attr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_i</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">message_with_attention_matrix</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Afterwards, we do a single inference step and record the attention matrix:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">input_tensor_torch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">half</span><span class="p">()</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_step</span><span class="p">(</span><span class="n">input_tensor_torch</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, the <code class="docutils literal notranslate"><span class="pre">alpha</span></code> tensor contains the attention for each edge from <code class="docutils literal notranslate"><span class="pre">j</span></code> to <code class="docutils literal notranslate"><span class="pre">i</span></code>.
We can try to interpret the attention matrix for a given target node.</p>
<p>For preparation, we create the hidden mesh as a directed graph with edges and attributes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="n">edges</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">graph_data</span><span class="o">.</span><span class="n">edge_stores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">edge_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">edges_with_attrs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edge_list</span><span class="p">):</span>
    <span class="n">attr_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;global_idx&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
        <span class="s2">&quot;coords&quot;</span><span class="p">:</span> <span class="n">coords</span><span class="p">[[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">],</span> <span class="p">:],</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
    <span class="p">}</span>
    <span class="n">edges_with_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">attr_dict</span><span class="p">))</span>

<span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">edges_with_attrs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then we select a subgraph for a given target node. We select the target node at random. Let’s use it as an example to examine the attention weights in more detail:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_node</span> <span class="o">=</span> <span class="mi">500</span> <span class="c1"># some arbitrary node index</span>
<span class="n">subgraph</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">edge_subgraph</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span><span class="n">target_node</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;coords = </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="n">target_node</span><span class="p">]</span><span class="si">}</span><span class="s2"> (lat/lon)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>coords = [ 41.424156 128.90453 ] (lat/lon)
</pre></div>
</div>
</div>
</div>
<p>The attention weights of all edges with <code class="docutils literal notranslate"><span class="pre">target_node</span></code> as receiver add to 1 for each of the heads:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">head</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># some arbitrary head index</span>
<span class="nb">sum</span><span class="p">([</span><span class="n">w</span><span class="p">[</span><span class="n">head</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor(1.0000)
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">weight</span></code> values, ie. the attention coefficients, represent the relative importance of neighbor j to node i when updating i’s features.
Before plotting the attention coefficients we enhance the relative difference between the weights:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">draw_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">w</span><span class="p">[</span><span class="n">head</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">)])</span>

<span class="n">draw_weights</span> <span class="o">=</span> <span class="n">draw_weights</span><span class="o">**</span><span class="mi">4</span>
<span class="n">draw_weights</span> <span class="o">=</span> <span class="mf">5.e1</span><span class="o">*</span><span class="n">draw_weights</span><span class="o">/</span><span class="n">draw_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">draw_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">edge</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="n">draw_weights</span><span class="p">)}</span>
<span class="n">nx</span><span class="o">.</span><span class="n">set_edge_attributes</span><span class="p">(</span><span class="n">subgraph</span><span class="p">,</span> <span class="n">draw_weight_dict</span><span class="p">,</span> <span class="s2">&quot;draw_weight&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.feature</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfeature</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">)</span>

<span class="n">d_lon</span> <span class="o">=</span> <span class="n">d_lat</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">tlat</span><span class="p">,</span> <span class="n">tlon</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">target_node</span><span class="p">]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="n">tlon</span> <span class="o">-</span> <span class="n">d_lon</span><span class="p">,</span> <span class="n">tlon</span> <span class="o">+</span> <span class="n">d_lon</span><span class="p">,</span> <span class="n">tlat</span> <span class="o">-</span> <span class="n">d_lat</span><span class="p">,</span> <span class="n">tlat</span> <span class="o">+</span> <span class="n">d_lat</span><span class="p">])</span>

<span class="c1"># Plot each line</span>
<span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;draw_weight&quot;</span><span class="p">],</span> 
             <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
             <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tlon</span><span class="p">,</span> <span class="n">tlat</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Receiver Point&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0f2336ae378ea9271657d7492cb5023a421da993237c560c1be05c110b802c2d.png" src="_images/0f2336ae378ea9271657d7492cb5023a421da993237c560c1be05c110b802c2d.png" />
</div>
</div>
<p>The above example graph visualizes which nodes are influencing each other.
Interpreting the attention matrices this way helps understanding how the model determines the importance of relationships between nodes across the graph.</p>
</section>
<section id="transfer-learning">
<h3>Transfer learning<a class="headerlink" href="#transfer-learning" title="Link to this heading">#</a></h3>
<p>Let’s take an excursion and create a second AICON setup. The only difference will be a finer, hidden multi-mesh.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">icon_mesh</span><span class="o">.</span><span class="n">node_builder</span><span class="o">.</span><span class="n">max_level_multimesh</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">trainer_new</span> <span class="o">=</span> <span class="n">AnemoiTrainer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">trainer_new</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">JupyterNotebookStrategy</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If we try to initialize the new ML model with the weight coefficients of the previous training model, we find that not all field sizes match:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="n">ckpt_file_old</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">hardware</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">checkpoints</span><span class="si">}{</span><span class="n">trainer</span><span class="o">.</span><span class="n">run_id</span><span class="si">}</span><span class="s2">/last.ckpt&quot;</span>
<span class="n">ckpt_old</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ckpt_file_old</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">weights_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">model_state_dict</span> <span class="o">=</span> <span class="n">trainer_new</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
<span class="n">state_dict</span> <span class="o">=</span> <span class="n">ckpt_old</span><span class="p">[</span><span class="s2">&quot;state_dict&quot;</span><span class="p">]</span>

<span class="c1"># First loop: collect shapes for matching keys</span>
<span class="n">shapes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="n">state_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">model_state_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state_dict</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">model_state_dict</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Seed set to 42000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># print mismatches:</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">shape_old</span><span class="p">,</span> <span class="n">shape_new</span><span class="p">)</span> <span class="ow">in</span> <span class="n">shapes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">shape_old</span> <span class="o">!=</span> <span class="n">shape_new</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Mismatch loading parameter: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  Checkpoint shape: </span><span class="si">{</span><span class="n">shape_old</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  Model shape:      </span><span class="si">{</span><span class="n">shape_new</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mismatch loading parameter: model.model.node_attributes.latlons_icon_mesh
  Checkpoint shape: torch.Size([5762, 4])
  Model shape:      torch.Size([23042, 4])

Mismatch loading parameter: model.model.node_attributes.latlons_hidden
  Checkpoint shape: torch.Size([5762, 4])
  Model shape:      torch.Size([23042, 4])

Mismatch loading parameter: model.model.node_attributes.trainable_tensors.icon_mesh.trainable
  Checkpoint shape: torch.Size([5762, 8])
  Model shape:      torch.Size([23042, 8])

Mismatch loading parameter: model.model.node_attributes.trainable_tensors.hidden.trainable
  Checkpoint shape: torch.Size([5762, 8])
  Model shape:      torch.Size([23042, 8])
</pre></div>
</div>
</div>
</div>
<p>In the list of model attributes, we see some incompatible, grid-dependent vectors.
As one might have expected, these are the node coordinates of the hidden mesh, as well as the trainable features mentioned briefly earlier. These node and edge attributes are treated as free parameters and updated during training.
However, all other model weights can be applied to the new mesh, despite its higher spatial resolution.</p>
<p>As long as the new graph’s higher resolution preserves the training graph’s essential structural and statistical properties, the GNN’s learned weights can effectively process and propagate information.
In other words, this is a type of “knowledge transfer” or <strong>transfer learning</strong> between problems. For example, it allows for the organization of a cost-efficient training schedule.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">anemoi.training.train.train</span>

<span class="n">console_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>  <span class="c1"># By default, outputs to console</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(levelname)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">console_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;anemoi.training.train.train&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console_handler</span><span class="p">)</span>
<span class="n">anemoi</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">LOGGER</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">config_new</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">config_new</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">load_weights_only</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">config_new</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">transfer_learning</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">config_new</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">run_id</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">run_id</span>

<span class="n">trainer_new</span> <span class="o">=</span> <span class="n">AnemoiTrainer</span><span class="p">(</span><span class="n">config_new</span><span class="p">)</span>
<span class="n">trainer_new</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">JupyterNotebookStrategy</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>

<span class="n">trainer_new</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO: Config validated.
INFO: Starting from checkpoint: True
INFO: Run id: 0210d057-147f-4d04-8d3f-df4b50044024
INFO: Checkpoints path: output_training/checkpoint/0210d057-147f-4d04-8d3f-df4b50044024
INFO: Plots path: output_training/mrl3/plots/0210d057-147f-4d04-8d3f-df4b50044024
INFO: Number of data variables: 123
INFO: Variables: [&#39;P_101&#39;, &#39;P_108&#39;, &#39;P_112&#39;, &#39;P_119&#39;, &#39;P_120&#39;, &#39;P_49&#39;, &#39;P_57&#39;, &#39;P_64&#39;, &#39;P_70&#39;, &#39;P_75&#39;, &#39;P_79&#39;, &#39;P_86&#39;, &#39;P_91&#39;, &#39;P_96&#39;, &#39;QV_101&#39;, &#39;QV_108&#39;, &#39;QV_112&#39;, &#39;QV_119&#39;, &#39;QV_120&#39;, &#39;QV_49&#39;, &#39;QV_57&#39;, &#39;QV_64&#39;, &#39;QV_70&#39;, &#39;QV_75&#39;, &#39;QV_79&#39;, &#39;QV_86&#39;, &#39;QV_91&#39;, &#39;QV_96&#39;, &#39;T_101&#39;, &#39;T_108&#39;, &#39;T_112&#39;, &#39;T_119&#39;, &#39;T_120&#39;, &#39;T_49&#39;, &#39;T_57&#39;, &#39;T_64&#39;, &#39;T_70&#39;, &#39;T_75&#39;, &#39;T_79&#39;, &#39;T_86&#39;, &#39;T_91&#39;, &#39;T_96&#39;, &#39;U_101&#39;, &#39;U_108&#39;, &#39;U_112&#39;, &#39;U_119&#39;, &#39;U_120&#39;, &#39;U_49&#39;, &#39;U_57&#39;, &#39;U_64&#39;, &#39;U_70&#39;, &#39;U_75&#39;, &#39;U_79&#39;, &#39;U_86&#39;, &#39;U_91&#39;, &#39;U_96&#39;, &#39;V_101&#39;, &#39;V_108&#39;, &#39;V_112&#39;, &#39;V_119&#39;, &#39;V_120&#39;, &#39;V_49&#39;, &#39;V_57&#39;, &#39;V_64&#39;, &#39;V_70&#39;, &#39;V_75&#39;, &#39;V_79&#39;, &#39;V_86&#39;, &#39;V_91&#39;, &#39;V_96&#39;, &#39;W_101&#39;, &#39;W_108&#39;, &#39;W_112&#39;, &#39;W_119&#39;, &#39;W_120&#39;, &#39;W_49&#39;, &#39;W_57&#39;, &#39;W_64&#39;, &#39;W_70&#39;, &#39;W_75&#39;, &#39;W_79&#39;, &#39;W_86&#39;, &#39;W_91&#39;, &#39;W_96&#39;, &#39;EMIS_RAD&#39;, &#39;FR_LAKE&#39;, &#39;FR_LAND&#39;, &#39;HSURF&#39;, &#39;SSO_GAMMA&#39;, &#39;SSO_SIGMA&#39;, &#39;SSO_STDH&#39;, &#39;SSO_THETA&#39;, &#39;Z0&#39;, &#39;cos_julian_day&#39;, &#39;cos_latitude&#39;, &#39;cos_local_time&#39;, &#39;cos_longitude&#39;, &#39;insolation&#39;, &#39;sin_julian_day&#39;, &#39;sin_latitude&#39;, &#39;sin_local_time&#39;, &#39;sin_longitude&#39;, &#39;ALB_RAD&#39;, &#39;CAPE_ML&#39;, &#39;CLCH&#39;, &#39;CLCL&#39;, &#39;CLCM&#39;, &#39;CLCT&#39;, &#39;FR_ICE&#39;, &#39;H_SNOW&#39;, &#39;PMSL&#39;, &#39;PS&#39;, &#39;QV_S&#39;, &#39;RAIN_CON&#39;, &#39;RELHUM_2M&#39;, &#39;SMI_0&#39;, &#39;SMI_1&#39;, &#39;TD_2M&#39;, &#39;TOT_PREC&#39;, &#39;T_2M&#39;, &#39;T_G&#39;, &#39;U_10M&#39;, &#39;V_10M&#39;]
INFO: Total number of prognostic variables: 105
INFO: Total number of auxiliary variables: 18
INFO: Total GPU count / model group size: 1 - NB: the learning rate will be scaled by this factor!
INFO: Effective learning rate: 1.000e-03
INFO: Training limits: max_epochs=2, max_steps=200. Training will stop when either limit is reached first. Learning rate scheduler will run for 1000 steps.
GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
Seed set to 42000
INFO: Initial seed: Rank 0, initial seed 42000, running with random seed: 42000
/shared/data/fprill/aicon_walkthrough/venv/src/anemoi-datasets/src/anemoi/datasets/data/forwards.py:517: UserWarning: The behaviour of Join.collect_supporting_arrays() is not well defined
  warnings.warn(f&quot;The behaviour of {self.__class__.__name__}.collect_supporting_arrays() is not well defined&quot;)
/shared/data/fprill/aicon_walkthrough/venv/src/anemoi-datasets/src/anemoi/datasets/data/forwards.py:517: UserWarning: The behaviour of Join.collect_supporting_arrays() is not well defined
  warnings.warn(f&quot;The behaviour of {self.__class__.__name__}.collect_supporting_arrays() is not well defined&quot;)
INFO: Resuming training from last checkpoint: output_training/checkpoint/0210d057-147f-4d04-8d3f-df4b50044024/last.ckpt
INFO: Loading weights with Transfer Learning from output_training/checkpoint/0210d057-147f-4d04-8d3f-df4b50044024/last.ckpt
INFO: The following submodules will NOT be trained: []
/shared/data/fprill/aicon_walkthrough/venv/lib64/python3.11/site-packages/pytorch_lightning/callbacks/model_checkpoint.py:881: Checkpoint directory /shared/data/fprill/aicon_walkthrough/aicon-walkthrough/doc/output_training/checkpoint/0210d057-147f-4d04-8d3f-df4b50044024 exists and is not empty.
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0,1,2,3,4,5,6,7]
</pre></div>
</div>
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━┳━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┳━━━━━━━┓
┃<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">   </span>┃<span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> Name    </span>┃<span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> Type                 </span>┃<span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> Params </span>┃<span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> Mode  </span>┃<span style="color: #800080; text-decoration-color: #800080; font-weight: bold"> FLOPs </span>┃
┡━━━╇━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━╇━━━━━━━┩
│<span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 0 </span>│ model   │ AnemoiModelInterface │  719 K │ train │     0 │
│<span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 1 </span>│ loss    │ WeightedMSELoss      │      0 │ train │     0 │
│<span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 2 </span>│ metrics │ ModuleDict           │      0 │ train │     0 │
└───┴─────────┴──────────────────────┴────────┴───────┴───────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Trainable params</span>: 719 K                                                                                            
<span style="font-weight: bold">Non-trainable params</span>: 0                                                                                            
<span style="font-weight: bold">Total params</span>: 719 K                                                                                                
<span style="font-weight: bold">Total estimated model params size (MB)</span>: 2                                                                          
<span style="font-weight: bold">Modules in train mode</span>: 102                                                                                         
<span style="font-weight: bold">Modules in eval mode</span>: 0                                                                                            
<span style="font-weight: bold">Total FLOPs</span>: 0                                                                                                     
</pre>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/shared/data/fprill/aicon_walkthrough/venv/src/anemoi-training/training/src/anemoi/training/losses/scaler_tensor.py:553: UserWarning: Using a non-tuple sequence for multidimensional indexing is deprecated and will be changed in pytorch 2.9; use x[tuple(seq)] instead of x[seq]. In pytorch 2.9 this will be interpreted as tensor index, x[torch.tensor(seq)], which will result either in an error or a different result (Triggered internally at /pytorch/torch/csrc/autograd/python_variable_indexing.cpp:355.)
  x_subset = x[subset_indices] if subset_indices is not None else x
/shared/data/fprill/aicon_walkthrough/venv/src/anemoi-training/training/src/anemoi/training/losses/scaler_tensor.py:576: UserWarning: Using a non-tuple sequence for multidimensional indexing is deprecated and will be changed in pytorch 2.9; use x[tuple(seq)] instead of x[seq]. In pytorch 2.9 this will be interpreted as tensor index, x[torch.tensor(seq)], which will result either in an error or a different result (Triggered internally at /pytorch/torch/csrc/autograd/python_variable_indexing.cpp:355.)
  reshaped_scaler = reshaped_scaler[subset_indices]
/shared/data/fprill/aicon_walkthrough/venv/src/anemoi-training/training/src/anemoi/training/losses/base.py:107: UserWarning: Using a non-tuple sequence for multidimensional indexing is deprecated and will be changed in pytorch 2.9; use x[tuple(seq)] instead of x[seq]. In pytorch 2.9 this will be interpreted as tensor index, x[torch.tensor(seq)], which will result either in an error or a different result (Triggered internally at /pytorch/torch/csrc/autograd/python_variable_indexing.cpp:355.)
  return x[subset_indices]
`Trainer.fit` stopped: `max_steps=200` reached.
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="running-the-dwd-inference-tool">
<h2>Running the DWD inference tool<a class="headerlink" href="#running-the-dwd-inference-tool" title="Link to this heading">#</a></h2>
<p>This final section describes the <strong><a class="reference external" href="https://gitlab.dkrz.de/dwd-ki-zentrum/apps/aicon-anemoi">AICON Anemoi Inference</a></strong> inference program.
This is not Anemoi’s “official” tool for running the trained model, but it is a custom implementation by DWD aiming towards operational application.
It differs from the existing Anemoi package <code class="docutils literal notranslate"><span class="pre">anemoi-inference</span></code> in terms of code length, special GRIB2 handling, and preprocessing capabilities, including the aggregation of the soil moisture and the recomputation of the soil moisture index SMI. The program is packaged into a container as part of the AICON operational setup.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="err">!</span><span class="n">git</span> <span class="n">clone</span> <span class="o">-</span><span class="n">b</span> <span class="n">aicon_walkthrough</span> <span class="n">git</span><span class="nd">@gitlab</span><span class="o">.</span><span class="n">dkrz</span><span class="o">.</span><span class="n">de</span><span class="p">:</span><span class="n">dwd</span><span class="o">-</span><span class="n">ki</span><span class="o">-</span><span class="n">zentrum</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">aicon</span><span class="o">-</span><span class="n">anemoi</span><span class="o">.</span><span class="n">git</span>
<span class="err">!</span><span class="n">cd</span> <span class="n">aicon</span><span class="o">-</span><span class="n">anemoi</span> <span class="o">&amp;&amp;</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="o">-</span><span class="n">e</span> <span class="o">.</span>
</pre></div>
</div>
</div>
</div>
<p>The inference tool <code class="docutils literal notranslate"><span class="pre">aicon-inference</span></code> is a command-line utility with various options:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>aicon-inference<span class="w"> </span>--help
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>usage: aicon-inference [-h] [--version] [--cfg CFG] [--print_config[=flags]]
                       [--checkpoint CHECKPOINT] [--grid_file GRID_FILE]
                       [--extpar_file EXTPAR_FILE] [--invar_file INVAR_FILE]
                       [--ana_files_date0 ANA_FILES_DATE0]
                       [--ana_files_date1 ANA_FILES_DATE1]
                       [--forecast_time FORECAST_TIME] [--initialstate]
                       [--grib_output [GRIB_OUTPUT]]
                       [--post_processor POST_PROCESSOR]
                       [--derive_variables DERIVE_VARIABLES]
                       [--accumulate ACCUMULATE]
                       [--use_deterministic_algorithms]

slim inference script for anemoi-core created model checkpoints.

options:
  -h, --help            show this help message and exit
  --version             show program&#39;s version number and exit
  --cfg CFG             Path to a configuration file. (default: None)
  --print_config[=flags]
                        Print the configuration after applying all other
                        arguments and exit. The optional flags customizes the
                        output and are one or more keywords separated by
                        comma. The supported flags are: comments,
                        skip_default, skip_null.
  --checkpoint CHECKPOINT
                        torch/pickle model checkpoint. (default: None)
  --grid_file GRID_FILE
                        path to ICON grid file (default:
                        /shared/data/fe1ai/ml-datasets/structure/01_aicon-
                        graph-files/icon_grid_0026_R03B07_G.nc)
  --extpar_file EXTPAR_FILE
                        path to ExtPar grib file (default: R3B7_mrl3.B/icon_ex
                        tpar_0026_R03B07_G_20231113_tiles.g2)
  --invar_file INVAR_FILE
                        path to invar grib file (default:
                        /shared/data/fe1ai/ml-datasets/dataset/08_invar_files/
                        invar_aicon_0026_R03B07_L013_20220601.grb)
  --ana_files_date0 ANA_FILES_DATE0
                        path to analysis,forecast grib files for (start date -
                        time_delta) (default: None)
  --ana_files_date1 ANA_FILES_DATE1
                        path to analysis,forecast grib files for start date
                        (default: None)
  --forecast_time FORECAST_TIME
                        Forecast time in hours. (default: 180)
  --initialstate        Write the initial state (default: False)
  --grib_output [GRIB_OUTPUT]
                        Enable and optionally configure grib output. Default
                        settings if enabled: [{&quot;filename_format&quot;:
                        &quot;aicon_{date:%Y%m%d%H}_{leadtime:03d}.grib2&quot;,
                        &quot;max_workers&quot;: 1, &quot;template&quot;: &quot;AICON_template.grib2&quot;,
                        &quot;additional_keys&quot;: {&quot;localNumberOfExperiment&quot;: 1,
                        &quot;generatingProcessIdentifier&quot;: 1,
                        &quot;productionStatusOfProcessedData&quot;: 2, &quot;bitsPerValue&quot;:
                        16, &quot;packingType&quot;: &quot;grid_ccsds&quot;}}] (default: [])
  --post_processor POST_PROCESSOR
                        Configure post processing (default: {})
  --derive_variables DERIVE_VARIABLES
                        Configure derive variables (default: {})
  --accumulate ACCUMULATE
                        list of variables to be accumulated over all output
                        time steps (default: [])
  --use_deterministic_algorithms
                        Use deterministic (i.e. reproducible) torch and CUDA
                        algorithms. (default: False)
</pre></div>
</div>
</div>
</div>
<p>We need some example data which we download from a server.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download_data</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s2">&quot;test_data_aicon_inference&quot;</span><span class="p">)</span> <span class="c1"># download data only if it does not exist</span>

<span class="k">if</span> <span class="n">download_data</span><span class="p">:</span>
  <span class="o">!</span>wget<span class="w"> </span>-r<span class="w"> </span>-H<span class="w"> </span>-N<span class="w"> </span>--cut-dirs<span class="o">=</span><span class="m">2</span><span class="w"> </span>--content-disposition<span class="w"> </span>-I<span class="w"> </span><span class="s2">&quot;/v1/&quot;</span><span class="w"> </span><span class="s2">&quot;https://swiftbrowser.dkrz.de/tcl_objects/2025-12-22T09:12:15Z/r_429459c3a284c7e843711ff5232dc81d2629ada4/w_/dkrz_e1060ac3d73b4204911afddb3bd7fc61/test_data_aicon_inference/0/?show_all&quot;</span>
  <span class="o">!</span>tar<span class="w"> </span>xvzf<span class="w"> </span>swift.dkrz.de/test_data_aicon_inference/test_data_aicon_inference.tar.gz
</pre></div>
</div>
</div>
</div>
<p>Especially the composition of the input tensor is a complex process that is conveniently handled by the inference tool. Arguments are provided via a YAML config file. A complete example call of the command line tool would look like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ckpt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">hardware</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">checkpoints</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">trainer</span><span class="o">.</span><span class="n">run_id</span><span class="si">}</span><span class="s2">/inference-last.ckpt&quot;</span>
<span class="o">%</span><span class="k">env</span> CHECKPOINT={ckpt}
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>env: CHECKPOINT=output_training/checkpoint//0210d057-147f-4d04-8d3f-df4b50044024/inference-last.ckpt
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;inference_test01.yaml&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">grid_file: test_data_aicon_inference/icon_grid_0026_R03B07_G.nc</span>
<span class="sd">extpar_file: test_data_aicon_inference/icon_extpar_0026_R03B07_G_20231113_tiles.g2</span>
<span class="sd">ana_files_date0: </span>
<span class="sd">  - test_data_aicon_inference/an_R03B07.2024083121</span>
<span class="sd">  - test_data_aicon_inference/fc_R03B07.2024083121</span>
<span class="sd">ana_files_date1: </span>
<span class="sd">  - test_data_aicon_inference/an_R03B07.2024090100</span>
<span class="sd">  - test_data_aicon_inference/fc_R03B07.2024090100</span>
<span class="sd">forecast_time: 12</span>
<span class="sd">grib_output:</span>
<span class="sd">  - filename_format: icon_output_0026_R03B07_G_{date:%Y%m%d%H}.grib2</span>
<span class="sd">    template: test_data_aicon_inference/AICON_template.MLPL.grib2</span>
<span class="sd">    additional_keys:</span>
<span class="sd">      localNumberOfExperiment: 1</span>
<span class="sd">      generatingProcessIdentifier: 1</span>
<span class="sd">post_processor:</span>
<span class="sd">  in_place: no</span>
<span class="sd">initialstate: yes</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>aicon-inference<span class="w"> </span>--checkpoint<span class="w"> </span><span class="nv">$CHECKPOINT</span><span class="w"> </span>--cfg<span class="w"> </span><span class="s2">&quot;inference_test01.yaml&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calculate soil moisture index (SMI) for 2024-08-31T21:00
  index 0: min=-0.7218013627629448 max=2.0
  index 1: min=-0.3260916742149758 max=2.0
Calculate soil moisture index (SMI) for 2024-09-01T00:00
  index 0: min=-0.7609507736650485 max=2.0
  index 1: min=-0.3260916742149758 max=2.0
output initial state
predicting step 1/2 2024-09-01T00:00
predicting step 2/2 2024-09-01T06:00
|===========================================================================|
|                  PyTorch CUDA memory summary, device ID 0                 |
|---------------------------------------------------------------------------|
|            CUDA OOMs: 0            |        cudaMalloc retries: 0         |
|===========================================================================|
|        Metric         | Cur Usage  | Peak Usage | Tot Alloc  | Tot Freed  |
|---------------------------------------------------------------------------|
| Allocated memory      |  23471 KiB | 288681 KiB |   2484 MiB |   2462 MiB |
|       from large pool |  14795 KiB | 279718 KiB |   2390 MiB |   2376 MiB |
|       from small pool |   8676 KiB |  15288 KiB |     94 MiB |     85 MiB |
|---------------------------------------------------------------------------|
| Active memory         |  23471 KiB | 288681 KiB |   2484 MiB |   2462 MiB |
|       from large pool |  14795 KiB | 279718 KiB |   2390 MiB |   2376 MiB |
|       from small pool |   8676 KiB |  15288 KiB |     94 MiB |     85 MiB |
|---------------------------------------------------------------------------|
| Requested memory      |  23448 KiB | 287008 KiB |   2429 MiB |   2406 MiB |
|       from large pool |  14793 KiB | 278074 KiB |   2335 MiB |   2320 MiB |
|       from small pool |   8654 KiB |  15260 KiB |     94 MiB |     85 MiB |
|---------------------------------------------------------------------------|
| GPU reserved memory   | 356352 KiB | 372736 KiB | 677888 KiB | 321536 KiB |
|       from large pool | 337920 KiB | 352256 KiB | 649216 KiB | 311296 KiB |
|       from small pool |  18432 KiB |  20480 KiB |  28672 KiB |  10240 KiB |
|---------------------------------------------------------------------------|
| Non-releasable memory |  27729 KiB |  58409 KiB |   2026 MiB |   1999 MiB |
|       from large pool |  26165 KiB |  57132 KiB |   1912 MiB |   1887 MiB |
|       from small pool |   1564 KiB |   5912 KiB |    113 MiB |    111 MiB |
|---------------------------------------------------------------------------|
| Allocations           |     139    |     239    |    1289    |    1150    |
|       from large pool |       5    |      31    |     453    |     448    |
|       from small pool |     134    |     214    |     836    |     702    |
|---------------------------------------------------------------------------|
| Active allocs         |     139    |     239    |    1289    |    1150    |
|       from large pool |       5    |      31    |     453    |     448    |
|       from small pool |     134    |     214    |     836    |     702    |
|---------------------------------------------------------------------------|
| GPU reserved segments |      24    |      25    |      42    |      18    |
|       from large pool |      15    |      15    |      28    |      13    |
|       from small pool |       9    |      10    |      14    |       5    |
|---------------------------------------------------------------------------|
| Non-releasable allocs |       7    |      28    |     519    |     512    |
|       from large pool |       3    |      13    |     298    |     295    |
|       from small pool |       4    |      23    |     221    |     217    |
|---------------------------------------------------------------------------|
| Oversize allocations  |       0    |       0    |       0    |       0    |
|---------------------------------------------------------------------------|
| Oversize GPU segments |       0    |       0    |       0    |       0    |
|===========================================================================|

[rank 0] inference: 2 calls, 0.3958s total, 0.1979s avg
[rank 0] inference loop: 1 calls, 2.6326s total, 2.6326s avg
[rank 0] init: 1 calls, 7.5754s total, 7.5754s avg
[rank 0] input_processing: 3 calls, 3.5287s total, 1.1762s avg
</pre></div>
</div>
</div>
</div>
<p>Internally, the inference script (asynchronously) takes care of the GRIB I/O.
For example, it reads the forcing fields, that provide external information to the model but are not predicted by the model itself. The inference checkpoint define a precise list of these fields:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">checkpoint</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">hardware</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">checkpoints</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">trainer</span><span class="o">.</span><span class="n">run_id</span><span class="si">}</span><span class="s2">/inference-last.ckpt&quot;</span>

<span class="c1"># extract meta-data from checkpoint:</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span><span class="o">,</span><span class="w"> </span><span class="nn">json</span>
<span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json_file</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ai-models.json&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">json_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">))</span>
    
<span class="n">variables</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">][</span><span class="s2">&quot;variables&quot;</span><span class="p">]</span>
<span class="n">indices_from</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;data_indices&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;full&quot;</span><span class="p">]</span>
<span class="n">indices_to</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;data_indices&quot;</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;full&quot;</span><span class="p">]</span>
<span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">i</span><span class="p">:</span> <span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indices_from</span><span class="p">,</span> <span class="n">indices_to</span><span class="p">)})</span>

<span class="c1"># forcing variables:</span>
<span class="p">[</span><span class="n">variables</span><span class="p">[</span><span class="n">mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;data_indices&quot;</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;forcing&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;EMIS_RAD&#39;,
 &#39;FR_LAKE&#39;,
 &#39;FR_LAND&#39;,
 &#39;HSURF&#39;,
 &#39;SSO_GAMMA&#39;,
 &#39;SSO_SIGMA&#39;,
 &#39;SSO_STDH&#39;,
 &#39;SSO_THETA&#39;,
 &#39;Z0&#39;,
 &#39;cos_julian_day&#39;,
 &#39;cos_latitude&#39;,
 &#39;cos_local_time&#39;,
 &#39;cos_longitude&#39;,
 &#39;insolation&#39;,
 &#39;sin_julian_day&#39;,
 &#39;sin_latitude&#39;,
 &#39;sin_local_time&#39;,
 &#39;sin_longitude&#39;]
</pre></div>
</div>
</div>
</div>
<p>In this list, the forcing variables are supplemented by so-called time-dependent <em>dynamic forcings</em>, currently <code class="docutils literal notranslate"><span class="pre">[&quot;cos_julian_day&quot;,</span> <span class="pre">&quot;sin_julian_day&quot;,</span> <span class="pre">&quot;cos_local_time&quot;,</span> <span class="pre">&quot;sin_local_time&quot;,</span> <span class="pre">&quot;insolation&quot;]</span></code>.
Let’s assume now that such an input dataset has been loaded into memory:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_tensor_torch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then, basically, the inference script repeatedly applies the following step to reach the desired forecast lead time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="c1"># Run the model in inference mode</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_step</span><span class="p">(</span><span class="n">input_tensor_torch</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we generate a sample plot of our test prediction:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.tri</span><span class="w"> </span><span class="kn">import</span> <span class="n">Triangulation</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">earthkit.data</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ekd</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="n">weights_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">lat</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">graph_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">lon</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">graph_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">field</span> <span class="o">=</span> <span class="n">ekd</span><span class="o">.</span><span class="n">from_source</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;icon_output_0026_R03B07_G_2024090100_cli.grib2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">shortName</span><span class="o">=</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>

<span class="n">tri</span> <span class="o">=</span> <span class="n">Triangulation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()})</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_global</span><span class="p">();</span> <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
<span class="n">tpc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tripcolor</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Spectral_r&quot;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tpc</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/eb5eced5ed54171c3827fba933a2ead9ebca3658ca80285beb1a29bd4c148070.png" src="_images/eb5eced5ed54171c3827fba933a2ead9ebca3658ca80285beb1a29bd4c148070.png" />
</div>
</div>
<p>One final remark: The inference tool is capable of directly writing output interpolated onto regular (rotated) latitude-longitude grids. To accomplish this, the necessary interpolation weights can be provided as a YAML config parameter. These weights are pre-calculated using the command-line utility <code class="docutils literal notranslate"><span class="pre">create_interpolation_weights_icon2reg.py</span></code>, utilizing numerical algorithms from the <a class="reference external" href="https://dkrz-sw.gitlab-pages.dkrz.de/yac/">ICON YAC coupler</a>. A detailed list of these algorithms can be accessed <a class="reference external" href="https://dkrz-sw.gitlab-pages.dkrz.de/yac/d0/da2/interp_methods.html">online</a>. You can find the interpolation tool <a class="reference external" href="https://gitlab.dkrz.de/dwd-ki-zentrum/infrastructure/yac-python">here</a>, and it is also available in a containerized version.</p>
<p>The AICON inference script itself has also been bundled as a <a class="reference external" href="https://apptainer.org/">Apptainer/Singularity</a> software container for operational use. This container is available on the DWD GPU cluster and can be found with the command <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">nwp;</span> <span class="pre">cwhence</span> <span class="pre">aicon-main.sif</span></code>. The necessary constant data can be found in the directory <code class="docutils literal notranslate"><span class="pre">/hpc/rhome/routfox/routfox/aiglo/aicon</span></code>. Note that the NetCDF grid therein is not a “classical” ICON grid file but a grid augmented by additional hierarchy information, see the section on the hidden mesh construction above.</p>
</section>
<hr class="docutils" />
<section id="bibliography">
<h2>Bibliography<a class="headerlink" href="#bibliography" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>[DWD2024] 6th WCRP International Conference on Reanalysis. (2024). ICON-DREAM: A new dual resolution reanalysis from DWD [Conference presentation]. https://confit.atlas.jp/guide/event/icr6/subject/OR2-01/detail</p></li>
<li><p>[Keisler2022] Keisler, R. (2022). Forecasting global weather with graph neural networks. arXiv. https://doi.org/10.48550/arXiv.22</p></li>
<li><p>[Lang2024] Lang, S., Alexe, M., Chantry, M., Dramsch, J., Pinault, F., Raoult, B., Clare, M. C. A., Lessig, C., Maier-Gerber, M., Magnusson, L., Ben Bouallègue, Z., Prieto Nemesio, A., Dueben, P. D., Brown, A., Pappenberger, F., &amp; Rabier, F. (2024). AIFS – ECMWF’s data-driven forecasting system (arXiv:2406.01465). arXiv. https://doi.org/10.48550/arXiv.2406.01465</p></li>
<li><p>[Lam2022] Lam, R., Sanchez-Gonzalez, A., Willson, M., Wirnsberger, P., Fortunato, M., Alet, F., Ravuri, S., Ewalds, T., Eaton-Rosen, Z., Hu, W., Merose, A., Hoyer, S., Holland, G., Vinyals, O., Stott, J., Pritzel, A., Mohamed, S., &amp; Battaglia, P. (2022). GraphCast: Learning skillful medium-range global weather forecasting. arXiv. https://arxiv.org/abs/2212.12794</p></li>
<li><p>[Prill2024] Prill, F., Reinert, D., Rieger, D., and Zängl, G.: ICON Tutorial - Working with the ICON model, Deutscher Wetterdienst, Offenbach, https://doi.org/10.5676/DWD_pub/nwv/icon_tutorial2024, 2024.</p></li>
<li><p>[Shi2021] Yunsheng Shi, Zhengjie Huang, Shikun Feng, Hui Zhong, Wenjin Wang, Yu Sun: Masked Label Prediction: Unified Message Passing Model for Semi-Supervised Classification. 2021, https://arxiv.org/abs/2009.03509</p></li>
</ul>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Contents</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aicon-model-training">AICON model training</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#driver-code">Driver code</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#training-datasets-and-variables">Training datasets and variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checkpoint-files">Checkpoint files</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hidden-mesh-multi-mesh-definition">Hidden mesh / multi-mesh definition</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-architecture">Model architecture</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#encoder-decoder-model">Encoder-decoder model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#encoder-and-decoder-graph">Encoder and decoder graph</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gnn-processor">GNN Processor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#attention-graph">Attention Graph</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transfer-learning">Transfer learning</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-dwd-inference-tool">Running the DWD inference tool</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bibliography">Bibliography</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Florian Prill (DWD), May 2025
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>